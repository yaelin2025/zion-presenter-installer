<!DOCTYPE html>
<html lang="es">

<head>
    <!-- 
     __  __   _   ___ _      ___ _____ ____ 
     \ \/ /  /_\ | __| |    / __|_   _|_  /
      \  /  / _ \| _|| |__ | (_ | | |  / / 
      |_|  /_/ \_\___|____| \___| |_| /___|
                                           
      Zion Presenter - Panel v2.0
      Desarrollado por Yael Gtz
    -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zion Presenter - Panel</title>
    <link rel="icon" type="image/png" href="img/favicon.png">
    <link rel="apple-touch-icon" href="img/favicon.png">
    <link rel="manifest" href="manifest.json">
    <!-- Fuente Local / Fallback -->
    <link href="css/fonts.css" rel="stylesheet">
    <!-- Librería para Presentaciones PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        // Configurar Worker de PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>

    <!-- Librería para códigos QR -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

    <!-- Zion Styles (Must be loaded LAST to override libraries) -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/zion-tutorial.css">
    <script src="Canciones.js"
        onerror="console.log('No se encontró Canciones.js (Modo automático desactivado)')"></script>
</head>

<body>
    <!-- Global SVG Assets (Shared Gradients) -->
    <svg style="position: absolute; width: 0; height: 0; overflow: hidden;" version="1.1"
        xmlns="http://www.w3.org/2000/svg">
        <defs>
            <linearGradient id="zionGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#FF9800" />
                <stop offset="50%" style="stop-color:#F44336" />
                <stop offset="100%" style="stop-color:#9C27B0" />
            </linearGradient>
        </defs>
    </svg>

    <!-- Inyección temprana de tema para evitar destellos blancos/negros -->
    <script>
        (function () {
            const savedMode = localStorage.getItem('bosquejos_lightmode');
            const isLight = savedMode === 'true';

            if (isLight) {
                document.body.classList.add('light-theme');
            }

            // Aplicar color de acento si existe configuración
            const configStr = localStorage.getItem('bosquejos_config');
            const root = document.documentElement.style;
            if (configStr) {
                try {
                    const config = JSON.parse(configStr);
                    if (config.themeColor) {
                        root.setProperty('--accent', config.themeColor);
                    } else {
                        root.setProperty('--accent', '#0ea5e9'); // Fallback default (Azul Cielo)
                    }
                } catch (e) {
                    root.setProperty('--accent', '#0ea5e9');
                }
            } else {
                root.setProperty('--accent', '#0ea5e9'); // Fallback default (Azul Cielo)
            }
        })();
    </script>

    <!-- PANTALLA DE CARGA (SPLASH SCREEN) DINÁMICA -->
    <div id="splashScreen" class="splash-container">
        <div class="splash-content">
            <!-- Logo SVG -->
            <img src="img/solologo.png" alt="Zion Logo" class="splash-logo-svg"
                style="width: 260px; height: 260px; object-fit: contain;">

            <!-- Texto Zion Presenter -->
            <div class="splash-text-box">
                <div class="splash-title-text">ZION</div>
                <div class="splash-subtitle-text">PRESENTER</div>
            </div>
        </div>
    </div>



    <div class="main-layout">
        <!-- VISTA DE CANTOS (Modular) -->
        <div id="songsView" class="view-container">
            <!-- El contenido se inyecta dinámicamente desde js/songs.js -->
        </div>
        <!-- FIN VISTA CANTOS -->

        <!-- VISTA DE BIBLIA (Modular) -->
        <div id="bibleView" class="view-container" style="display: none;">
            <!-- El contenido se inyecta dinámicamente desde js/bible.js -->
        </div>
        <!-- FIN VISTA BIBLIA -->

        <div id="announcementsView" class="view-container" style="display: none;">
            <!-- El contenido se inyecta dinámicamente desde js/announcements.js -->
        </div>
        <!-- FIN VISTA ANUNCIOS -->

        <div id="presentationsView" class="view-container" style="display: none;">
            <!-- El contenido se inyecta dinámicamente desde js/presentations.js -->
        </div>
        <!-- FIN VISTA PRESENTACIONES -->

        <!-- FIN VISTA PRESENTACIONES -->

        <!-- FILA INFERIOR: OPCIONES PRO -->





        <!-- FILA INFERIOR: OPCIONES PRO -->

    </div>

    <!-- MODAL PARA AGREGAR/EDITAR CANTO (VERSION PRO) -->
    <div id="songModal" class="modal-overlay"
        style="display:none; position:fixed; inset:0; z-index:11000; align-items:center; justify-content:center; background: rgba(0,0,0,0.6);">
        <div class="glass-card song-modal-content"
            style="width: 900px; max-width:95%; height: 600px; display: flex; flex-direction: column; padding: 0; overflow: hidden;">

            <!-- Barra Superior -->
            <div class="modal-header-bar"
                style="padding: 15px 25px; border-bottom: 1px solid var(--card-border); display: flex; justify-content: space-between; align-items: center;">
                <h2 id="modalTitle" style="margin:0; font-size: 18px; color: var(--accent);">Nuevo Canto</h2>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span id="slideCounter" class="modal-badge">0 Diapositivas</span>
                    <button onclick="closeSongModal()" class="btn-close-modal" title="Cerrar (Esc)">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
            </div>

            <div style="display: flex; flex: 1; overflow: hidden;">
                <!-- Panel Izquierdo: Editor -->
                <div class="modal-editor-pane"
                    style="flex: 1.2; padding: 25px; display: flex; flex-direction: column; gap: 15px; border-right: 1px solid var(--card-border);">
                    <input type="hidden" id="songId">

                    <div style="display: flex; gap: 15px;">
                        <div style="flex: 1;">
                            <label class="modal-label">Título del Canto</label>
                            <input type="text" id="songTitle" placeholder="Ej: Tu Fidelidad" class="modal-input">
                        </div>
                        <div style="flex: 0.6;">
                            <label class="modal-label">Cantado por / Líder</label>
                            <input type="text" id="songSinger" placeholder="Ej: Hna. María" class="modal-input">
                        </div>
                    </div>

                    <div style="flex: 1; display: flex; flex-direction: column;">
                        <label class="modal-label">Letra (Doble Enter para nueva diapositiva)</label>
                        <textarea id="songLyrics" class="modal-input modal-textarea"
                            placeholder="Escribe la letra aquí...&#10;&#10;Usa doble línea para separar estrofas."
                            oninput="updateSongPreview()"></textarea>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button class="secondary" onclick="closeSongModal()"
                            style="flex:1; padding: 12px; border-radius: 10px; font-weight: 600;">CANCELAR</button>
                        <button class="primary" onclick="saveSong()"
                            style="flex:1.5; padding: 12px; border-radius: 10px; font-weight: 700; background: var(--accent); border: none; color: var(--btn-text-color); cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.15);">GUARDAR
                            CANTO</button>
                    </div>
                </div>

                <!-- Panel Derecho: Vista Previa en Vivo -->
                <div class="modal-preview-pane"
                    style="flex: 0.8; padding: 25px; display: flex; flex-direction: column; gap: 15px;">
                    <label class="modal-label">Vista Previa de Diapositivas</label>
                    <div id="songLivePreview" class="scroll-list modal-preview-list"
                        style="flex: 1; display: flex; flex-direction: column; gap: 10px; padding: 5px;">
                        <div class="preview-empty-state">
                            Escribe para ver como se verán las diapositivas.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL IMPORTAR ELIMINADO -->

    <!-- Lógica Modular -->
    <script src="js/utils.js"></script>

    <!-- CRITICAL: Initialize room code BEFORE projection.js -->
    <script>
        // En modo LOCAL (Instalador), eliminamos el sistema de salas aleatorias
        window.zionRoomCode = 'GLOBAL';
        localStorage.setItem('zion_panel_room', 'GLOBAL');

        console.log(`Sistema de comunicación global activo.`);
    </script>

    <script src="js/projection.js?v=4.0"></script>
    <script src="js/config.js?v=4.0"></script>
    <script src="js/bible.js?v=4.0"></script>
    <script src="js/songs.js?v=4.0"></script>
    <script src="js/announcements.js?v=4.0"></script>
    <script src="js/presentations.js?v=4.0"></script>
    <script src="js/timer.js?v=4.0"></script> <!-- Nuevo módulo de Relojes -->
    <script src="js/media_db.js?v=4.0"></script> <!-- Base de datos Multimedia -->
    <script src="js/unsplash.js?v=4.0"></script> <!-- Integración Unsplash -->
    <script src="js/main.js?v=4.1"></script>
    <script src="js/zion-analytics.js"></script>
    <script src="js/zion-tutorial.js"></script>



    <!-- MODAL DE CRÉDITOS (Oculto) -->
    <div id="aboutModal" class="modal-overlay" onclick="closeModal('aboutModal')"
        style="display:none; position:fixed; inset:0; background: var(--modal-overlay); z-index:20000; align-items:center; justify-content:center; opacity:0;">

        <div class="glass-card about-card modal-content-animated" onclick="event.stopPropagation()"
            style="background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 20px; padding: clamp(15px, 2.5vh, 25px); width: 92%; max-width: 900px; height: auto; max-height: 98vh; display: flex; flex-direction: column; align-items: stretch; box-shadow: 0 40px 100px rgba(0,0,0,0.5); position: relative; transform-origin: center; overflow: hidden;">

            <!-- Subtle Background Glow -->
            <div
                style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, var(--brand-glow) 0%, transparent 70%); pointer-events: none; opacity: 0.3;">
            </div>

            <!-- BOTÓN CERRAR (X) - SUPERIOR IZQUIERDA -->
            <button onclick="closeModal('aboutModal')" class="btn-close-modal"
                style="position: absolute; top: 15px; left: 15px; z-index: 10;" title="Cerrar (Esc)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
                    stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>

            <!-- HEADER COMPACTO (CENTRADO) -->
            <div
                style="display: flex; justify-content: center; align-items: center; margin-bottom: 1.5vh; margin-top: -10px; border-bottom: 1px solid var(--card-border); padding-bottom: 1vh; position: relative;">

                <!-- LOGO CENTRADO -->
                <div style="display: flex; align-items: center; gap: 8px;">
                    <img src="img/solologo.png" alt="Zion Logo"
                        style="width: clamp(60px, 7vh, 90px); height: clamp(60px, 7vh, 90px); object-fit: contain;">
                    <div style="text-align: left;">
                        <div
                            style="font-weight: 900; font-size: clamp(20px, 3vh, 28px); letter-spacing: 1px; color: var(--text); line-height: 0.8;">
                            ZION</div>
                        <div
                            style="font-weight: 300; font-size: clamp(10px, 1.5vh, 14px); letter-spacing: 4px; color: var(--text); line-height: 1; margin-top: 4px;">
                            PRESENTER</div>
                    </div>
                </div>

                <!-- INFO DERECHA (ABSOLUTE) -->
                <div style="position: absolute; right: 0; top: 0; text-align: right;">
                    <div
                        style="font-size: 18px; font-weight: 800; color: var(--text); letter-spacing: 1px; line-height: 1.1;">
                        YAEL GTZ</div>
                    <div
                        style="font-size: 9px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px; font-weight: 600;">
                        System Architect & Designer</div>
                </div>
            </div>

            <!-- GRID INFO (2x2) -->
            <!-- GRID INFO (2x2) -->
            <div id="techGrid" class="about-grid"
                style="margin-bottom: 1.5vh; border-bottom: 1px solid var(--card-border); padding: 0 5px 1.5vh 5px; transition: opacity 0.3s ease; display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">

                <!-- COL 1: CORE -->
                <div>
                    <h3
                        style="color: var(--text); font-size: clamp(9px, 1.2vh, 11px); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; border-bottom: 1px solid var(--card-border); padding-bottom: 3px;">
                        <span style="color: var(--accent);">-</span> Core & Network
                    </h3>
                    <ul
                        style="list-style: none; padding: 0; margin: 0; color: var(--text-muted); font-size: clamp(9px, 1.1vh, 10.5px); line-height: 1.4; font-family: 'Inter', sans-serif;">
                        <li style="display:flex; justify-content:space-between;"><span>Platform</span> <span
                                style="color: var(--text); font-weight: 600;">Web App</span></li>
                        <li style="display:flex; justify-content:space-between;"><span>Backend</span> <span
                                style="color: var(--text); font-weight: 600;">Node.js + Express</span></li>
                        <li style="display:flex; justify-content:space-between;"><span>Network</span> <span
                                style="color: var(--text); font-weight: 600;">Socket.IO Rooms</span></li>
                        <li style="display:flex; justify-content:space-between;"><span>Deploy</span> <span
                                style="color: var(--text); font-weight: 600;">GitHub Pages</span></li>
                    </ul>
                </div>

                <!-- COL 2: MODULES -->
                <div>
                    <h3
                        style="color: var(--text); font-size: 11px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; border-bottom: 1px solid var(--card-border); padding-bottom: 4px;">
                        <span style="color: var(--accent);">-</span> Modules
                    </h3>
                    <ul
                        style="list-style: none; padding: 0; margin: 0; color: var(--text-muted); font-size: 11px; line-height: 1.6; font-family: 'Inter', sans-serif;">
                        <li style="display:flex; justify-content:space-between;"><span>Manager</span> <span
                                style="color: var(--text); font-weight: 600;">Songs & Sets</span></li>
                        <li style="display:flex; justify-content:space-between;"><span>Bible</span> <span
                                style="color: var(--text); font-weight: 600;">RV1960 / LXX</span></li>
                        <li style="display:flex; justify-content:space-between;"><span>Tools</span> <span
                                style="color: var(--text); font-weight: 600;">Timers & Stopw.</span></li>
                        <li style="display:flex; justify-content:space-between;"><span>Info</span> <span
                                style="color: var(--text); font-weight: 600;">Announcements</span></li>
                    </ul>
                </div>

                <!-- COL 3: VISUAL ENGINE -->
                <div>
                    <h3
                        style="color: var(--text); font-size: 11px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; border-bottom: 1px solid var(--card-border); padding-bottom: 4px;">
                        <span style="color: #06b6d4;">●</span> Visual Engine
                    </h3>
                    <ul
                        style="list-style: none; padding: 0; margin: 0; color: var(--text-muted); font-size: 11px; line-height: 1.6; font-family: 'Inter', sans-serif;">
                        <li>• Real-Time Output Projection</li>
                        <li>• Glassmorphism Design System</li>
                        <li>• Dynamic Overlay Composition</li>
                        <li>• Smart Text Formatting/Sizing</li>
                    </ul>
                </div>

                <!-- COL 4: TECH STACK -->
                <div>
                    <h3
                        style="color: var(--text); font-size: 11px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; border-bottom: 1px solid var(--card-border); padding-bottom: 4px;">
                        <span style="color: #10b981;">●</span> Tech Stack
                    </h3>
                    <ul
                        style="list-style: none; padding: 0; margin: 0; color: var(--text-muted); font-size: 11px; line-height: 1.6; font-family: 'Inter', sans-serif;">
                        <li style="display:flex; justify-content:space-between;"><span>Framework</span> <span
                                style="color: var(--text); font-weight: 600;">Vanilla JS</span></li>
                        <li style="display:flex; justify-content:space-between;"><span>Styles</span> <span
                                style="color: var(--text); font-weight: 600;">CSS3 + Vars</span></li>
                        <li style="display:flex; justify-content:space-between;"><span>Database</span> <span
                                style="color: var(--text); font-weight: 600;">IndexedDB</span></li>
                        <li style="display:flex; justify-content:space-between;"><span>Media</span> <span
                                style="color: var(--text); font-weight: 600;">Unsplash API</span></li>
                    </ul>
                </div>
            </div>



            <!-- SECCIÓN NOVEDADES v3.0 (Oculta por defecto) -->
            <div id="newsSection"
                style="display: none; opacity: 0; transition: opacity 0.5s ease; margin-bottom: 1.5vh; border-bottom: 1px solid var(--card-border); padding: 0 5px 1vh 5px; background: var(--quote-bg); border-radius: 8px; margin-top: 1vh;">
                <!-- CATEGORÍA: NOVEDADES -->
                <h3
                    style="color: var(--accent); font-size: clamp(10px, 1.2vh, 11px); text-transform: uppercase; letter-spacing: 1.5px; margin: 1vh 0 0.8vh 0; display: flex; align-items: center; gap: 8px;">
                    <span
                        style="background: var(--accent); color: #000; padding: 2px 6px; border-radius: 4px; font-size: 9px;">NEW</span>
                    Funciones v3.0
                </h3>
                <ul
                    style="list-style: none; padding: 0; margin: 0 0 1vh 0; display: grid; grid-template-columns: 1fr 1fr; gap: 0.8vh 15px; font-size: clamp(9px, 1.1vh, 10.5px); font-family: 'Inter', sans-serif; color: var(--text-muted); line-height: 1.3;">
                    <li>
                        <strong style="color: var(--text); display:block; margin-bottom:2px;">Mega Pack Biblias</strong>
                        15 nuevas versiones dinámicas (NVI, TLA, LBLA, LXX, etc).
                    </li>
                    <li>
                        <strong style="color: var(--text); display:block; margin-bottom:2px;">Modo Comparativo</strong>
                        Proyección Dual de versículos para estudio bíblico profundo.
                    </li>
                    <li>
                        <strong style="color: var(--text); display:block; margin-bottom:2px;">Glassmorphism UI</strong>
                        Diseño Premium con efectos de cristal, neón y modo oscuro.
                    </li>
                    <li>
                        <strong style="color: var(--text); display:block; margin-bottom:2px;">Módulo de Tiempos</strong>
                        Relojes y Cronómetros avanzados integrados en el overlay.
                    </li>
                    <li>
                        <strong style="color: var(--text); display:block; margin-bottom:2px;">Persistencia Full</strong>
                        Estado de la app y fondos guardados en base de datos local.
                    </li>
                    <li>
                        <strong style="color: var(--text); display:block; margin-bottom:2px;">Red Local 2.0</strong>
                        Sincronización robusta con múltiples pantallas y Zion Cast.
                    </li>
                </ul>

                <!-- CATEGORÍA: CORRECCIONES -->
                <h3
                    style="color: var(--text); font-size: clamp(10px, 1.2vh, 11px); text-transform: uppercase; letter-spacing: 1.5px; margin: 1vh 0 0.8vh 0; display: flex; align-items: center; gap: 8px; opacity: 0.8;">
                    <span
                        style="background: var(--text-muted); color: #000; padding: 2px 6px; border-radius: 4px; font-size: 9px;">FIX</span>
                    Mejoras y Parches
                </h3>
                <ul
                    style="list-style: none; padding: 0; margin: 0; display: grid; grid-template-columns: 1fr 1fr; gap: 0.8vh 15px; font-size: clamp(9px, 1.1vh, 10.5px); font-family: 'Inter', sans-serif; color: var(--text-muted); line-height: 1.3;">
                    <li>
                        <strong style="color: var(--text); display:block; margin-bottom:2px;">Legibilidad
                            Optimizada</strong>
                        Tipografías BenchNine/Inter con sombra sólida al 100%.
                    </li>
                    <li>
                        <strong style="color: var(--text); display:block; margin-bottom:2px;">Corrección UI
                            Biblia</strong>
                        Alineación perfecta de botones, selectores y buscadores.
                    </li>
                    <li>
                        <strong style="color: var(--text); display:block; margin-bottom:2px;">Optimización CPU</strong>
                        Eliminado lag al seleccionar texto eliminando transforms.
                    </li>
                    <li>
                        <strong style="color: var(--text); display:block; margin-bottom:2px;">Fondo Inteligente</strong>
                        El blur ya no afecta a medios multimedia de contenido.
                    </li>
                    <li>
                        <strong style="color: var(--text); display:block; margin-bottom:2px;">Smart Search
                            Bible</strong>
                        Normalización automática para LXX y versiones antiguas.
                    </li>
                    <li>
                        <strong style="color: var(--text); display:block; margin-bottom:2px;">Zero-Lag Loading</strong>
                        Carga dinámica de scripts para ahorro de RAM y estabilidad.
                    </li>
                </ul>
            </div>

            <!-- Script Inline para Toggle y Seguridad -->
            <script>
                function toggleNews() {
                    const news = document.getElementById('newsSection');
                    const tech = document.getElementById('techGrid');
                    const dedication = document.getElementById('dedication');
                    const footer = document.getElementById('legalFooter');
                    const btn = document.querySelector('button[onclick="toggleNews()"]');

                    if (news.style.display === 'none' || news.style.display === '') {
                        // MOSTRAR NOVEDADES, OCULTAR LO DEMÁS
                        if (tech) tech.style.opacity = '0';
                        if (dedication) dedication.style.opacity = '0';
                        if (footer) footer.style.opacity = '0';

                        setTimeout(() => {
                            if (tech) tech.style.display = 'none';
                            if (dedication) dedication.style.display = 'none';
                            if (footer) footer.style.display = 'none';

                            news.style.display = 'block';
                            void news.offsetWidth;
                            news.style.opacity = '1';
                        }, 300);

                        if (btn) {
                            btn.innerText = "Volver";
                            btn.style.background = "var(--accent)";
                            btn.style.color = "#000";
                        }
                    } else {
                        // OCULTAR NOVEDADES, MOSTRAR LO DEMÁS
                        news.style.opacity = '0';

                        setTimeout(() => {
                            news.style.display = 'none';
                            if (tech) tech.style.display = 'grid';
                            if (dedication) dedication.style.display = 'block';
                            if (footer) footer.style.display = 'flex';

                            void tech.offsetWidth;
                            if (tech) { tech.style.opacity = '1'; }
                            if (dedication) dedication.style.opacity = '1';
                            if (footer) footer.style.opacity = '1';
                        }, 300);

                        if (btn) {
                            btn.innerText = "Ver Novedades";
                            btn.style.background = "transparent";
                            btn.style.color = "var(--accent)";
                        }
                    }
                }

                // SECURITY LAYER 2.0: Deep Protection
                /*
                (function () {
                    const block = () => {
                        setInterval(() => { (function () { return false; }['constructor']('debugger')['call']()); }, 50);
                    };
                    try { block(); } catch (err) { }
                })();

                document.addEventListener('contextmenu', e => e.preventDefault());
                document.onkeydown = function (e) {
                    if (e.keyCode == 123 || (e.ctrlKey && e.shiftKey && (e.keyCode == 73 || e.keyCode == 74 || e.keyCode == 67)) || (e.ctrlKey && e.keyCode == 85)) return false;
                };
                */
            </script>

            <!-- MENSAJE PERSONAL (DEDICATORIA) -->
            <!-- MENSAJE PERSONAL (DEDICATORIA) -->
            <div id="dedication"
                style="margin: 1.5vh 0; padding: 1.5vh clamp(15px, 5%, 40px); background: var(--quote-bg); border-left: 3px solid var(--accent); border-radius: 8px; transition: opacity 0.3s ease;">
                <p
                    style="font-family: 'Inter', sans-serif; font-size: clamp(10px, 1.5vh, 13px); line-height: 1.5; color: var(--text); font-style: italic; margin: 0;">
                    "Dicen que el arte nace de la necesidad, Zion Presenter nació de la necesidad de nuestra comunidad
                    por
                    facilitar las proyecciones en las iglesias. Este proyecto fue creado con mucho trabajo y una
                    dedicación inquebrantable. Les entrego no solo una herramienta, sino un recurso pensado para que el
                    mensaje brille con excelencia."
                </p>
                <div
                    style="text-align: right; margin-top: 8px; font-size: clamp(9px, 1.1vh, 11px); color: var(--accent); font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
                    — Yael Gutierrez, 2025
                </div>
            </div>
            <!-- SECCIÓN DE CRÉDITOS Y LICENCIAS -->
            <div id="creditsSection"
                style="margin: 1.5vh 0; padding: clamp(10px, 1.5vh, 15px); background: var(--quote-bg); border-radius: 8px; transition: opacity 0.3s ease;">
                <h3 style="color: var(--text); font-size: clamp(10px, 1.3vh, 11px); text-transform: uppercase; letter-spacing: 1.5px; margin: 0 0 10px 0;
border-bottom: 1px solid var(--card-border); padding-bottom: 4px;">
                    Créditos y Reconocimientos
                </h3>
                <div style="display: grid; grid-template-columns: 1.3fr 1fr 1fr 1fr; gap: 12px; font-size: clamp(8.5px, 1.1vh, 10px); color: var(--text-muted);
line-height: 1.4;">
                    <div>
                        <strong style="color: var(--text); display: block; margin-bottom: 4px;">Versiones Bíblicas
                            (Atribución)</strong>
                        Se incluyen textos de: Reina Valera (1960, 1995, 1909, Contemporánea, Actualizada, Purificada,
                        Gomez), NVI, DHH, NTV, TLA, LBLA, PDT, Biblia Textual (BTX), Sagradas Escrituras (Oso) y
                        Septuaginta (LXX). Todos los derechos pertenecen a sus respectivas Sociedades Bíblicas y
                        Editoriales. Su uso es estrictamente ministerial y sin fines de lucro.
                    </div>
                    <div>
                        <strong style="color: var(--text); display: block; margin-bottom: 4px;">Cantos y Letras</strong>
                        Las letras de canciones pertenecen a sus respectivos autores, compositores y editoriales
                        musicales. Su uso en esta herramienta es exclusivamente para fines eclesiásticos y
                        ministeriales, sin ánimo de lucro.
                    </div>
                    <div>
                        <strong style="color: var(--text); display: block; margin-bottom: 4px;">Recursos
                            Visuales</strong>
                        Integración multimedia potenciada por <span style="color: var(--accent);">Unsplash API</span>.
                        Tipografías por <span style="color: var(--accent);">Google Fonts</span> (Inter, BenchNine,
                        Roboto).
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <div>
                            <strong style="color: var(--text); display: block; margin-bottom: 4px;">Software &
                                Legal</strong>
                            Motor desarrollado con Node.js y Socket.io bajo <span style="color: var(--accent);">Licencia
                                Propietaria</span>.
                        </div>
                        <div>
                            <strong style="color: var(--text); display: block; margin-bottom: 4px;">Aviso Legal</strong>
                            Esta herramienta no almacena contenido protegido permanentemente en sus servidores.
                        </div>
                    </div>
                </div>
            </div>


            <!-- FOOTER LEGAL -->
            <!-- FOOTER LEGAL -->
            <div id="legalFooter"
                style="border-top: 1px solid var(--card-border); padding-top: 8px; margin-top: auto; display: flex; justify-content: space-between; align-items: center; color: var(--text-muted); font-size: 9px; font-weight: 500; transition: opacity 0.3s ease;">
                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                    <div>
                        &copy; 2026 YAEL GTZ SYSTEMS.<br>
                        <span style="color: var(--accent);">Edición Gratuita</span>
                    </div>
                    <span
                        style="background: var(--active-bg); color: var(--accent); padding: 3px 10px; border-radius: 5px; font-size: 10px; font-weight: 700; border: 1px solid var(--accent);">
                        v3.0
                    </span>
                    <span
                        style="background: var(--active-bg); color: var(--accent); padding: 3px 10px; border-radius: 5px; font-size: 10px; font-weight: 700; border: 1px solid var(--accent);">
                        EDICIÓN FINAL
                    </span>
                    <button onclick="toggleNews()"
                        style="background: transparent; border: 1px solid var(--accent); color: var(--accent); font-size: 9px; padding: 4px 8px; border-radius: 4px; cursor: pointer; text-transform: uppercase; font-weight: 700; letter-spacing: 1px; transition: all 0.3s;">
                        Ver Novedades
                    </button>
                </div>
                <div style="text-align: right; font-style: italic; opacity: 0.7;">
                    "Soli Deo Gloria"
                </div>
            </div>



        </div>
    </div>

    <!-- MODAL DE CONTACTO -->
    <div id="contactModal" class="modal-overlay" onclick="closeModal('contactModal')"
        style="display:none; position:fixed; inset:0; background: var(--modal-overlay); z-index:20000; align-items:center; justify-content:center; opacity:0;">

        <div class="glass-card about-card modal-content-animated" onclick="event.stopPropagation()"
            style="background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 20px; padding: clamp(20px, 3vh, 30px); width: 92%; max-width: 600px; height: auto; max-height: 90vh; display: flex; flex-direction: column; align-items: stretch; box-shadow: 0 40px 100px rgba(0,0,0,0.5); position: relative; transform-origin: center; overflow: hidden;">

            <!-- Subtle Background Glow -->
            <div
                style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, var(--brand-glow) 0%, transparent 70%); pointer-events: none; opacity: 0.3;">
            </div>

            <!-- BOTÓN CERRAR (X) -->
            <button onclick="closeModal('contactModal')" class="btn-close-modal"
                style="position: absolute; top: 15px; left: 15px; z-index: 10;" title="Cerrar (Esc)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
                    stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>

            <!-- HEADER -->
            <div style="text-align: center; margin-bottom: 25px; padding-top: 10px;">
                <h2
                    style="margin: 0 0 10px 0; font-size: clamp(22px, 4vh, 28px); color: var(--text); text-align: center; display: block; width: 100%;">
                    Contacto & Soporte
                </h2>
                <p style="margin: 0; font-size: 13px; color: var(--text-muted); line-height: 1.4;">
                    ¿Necesitas ayuda o quieres reportar un problema? Contáctame por cualquiera de estos medios
                </p>
            </div>

            <!-- GRID DE CONTACTOS -->
            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">

                <!-- WhatsApp -->
                <a href="https://wa.me/5216144688228" target="_blank" rel="noopener noreferrer"
                    style="display: flex; align-items: center; gap: 12px; padding: 15px; background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 12px; text-decoration: none; color: var(--text); transition: all 0.3s; position: relative; overflow: hidden;"
                    onmouseover="this.style.borderColor='#25D366'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 20px rgba(37, 211, 102, 0.2)'"
                    onmouseout="this.style.borderColor='var(--card-border)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="#25D366" style="flex-shrink: 0;">
                        <path
                            d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z" />
                    </svg>
                    <div style="flex: 1;">
                        <div
                            style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 3px;">
                            WhatsApp</div>
                        <div style="font-size: 14px; font-weight: 600; color: var(--text);">+52 614 468 8228</div>
                        <div style="font-size: 10px; color: var(--text-muted); margin-top: 2px;">Chihuahua, México</div>
                    </div>
                </a>

                <!-- Email -->
                <a href="mailto:YaelGtz@outlook.com"
                    style="display: flex; align-items: center; gap: 12px; padding: 15px; background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 12px; text-decoration: none; color: var(--text); transition: all 0.3s;"
                    onmouseover="this.style.borderColor='var(--accent)'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 20px rgba(236, 72, 153, 0.2)'"
                    onmouseout="this.style.borderColor='var(--card-border)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round" style="flex-shrink: 0;">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                        <polyline points="22,6 12,13 2,6"></polyline>
                    </svg>
                    <div style="flex: 1;">
                        <div
                            style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 3px;">
                            Email</div>
                        <div style="font-size: 14px; font-weight: 600; color: var(--text); word-break: break-all;">
                            YaelGtz@outlook.com</div>
                    </div>
                </a>

                <!-- Facebook -->
                <a href="https://www.facebook.com/profile.php?id=61577180301436" target="_blank"
                    rel="noopener noreferrer"
                    style="display: flex; align-items: center; gap: 12px; padding: 15px; background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 12px; text-decoration: none; color: var(--text); transition: all 0.3s;"
                    onmouseover="this.style.borderColor='#1877F2'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 20px rgba(24, 119, 242, 0.2)'"
                    onmouseout="this.style.borderColor='var(--card-border)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="#1877F2" style="flex-shrink: 0;">
                        <path
                            d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z" />
                    </svg>
                    <div style="flex: 1;">
                        <div
                            style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 3px;">
                            Facebook</div>
                        <div style="font-size: 14px; font-weight: 600; color: var(--text);">Yael Gutierrez</div>
                    </div>
                </a>

                <!-- YouTube -->
                <a href="https://www.youtube.com/@jannydfds1" target="_blank" rel="noopener noreferrer"
                    style="display: flex; align-items: center; gap: 12px; padding: 15px; background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 12px; text-decoration: none; color: var(--text); transition: all 0.3s;"
                    onmouseover="this.style.borderColor='#FF0000'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 20px rgba(255, 0, 0, 0.2)'"
                    onmouseout="this.style.borderColor='var(--card-border)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="#FF0000" style="flex-shrink: 0;">
                        <path
                            d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z" />
                    </svg>
                    <div style="flex: 1;">
                        <div
                            style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 3px;">
                            YouTube</div>
                        <div style="font-size: 14px; font-weight: 600; color: var(--text);">@jannydfds1</div>
                        <div style="font-size: 10px; color: var(--text-muted); margin-top: 2px;">Tutoriales y más</div>
                    </div>
                </a>

            </div>

            <!-- NOTA FINAL -->
            <div
                style="margin-top: 10px; padding: 15px; background: linear-gradient(135deg, var(--accent) 0%, var(--brand-glow) 100%); border-radius: 12px; color: white; text-align: center;">
                <div style="font-size: 13px; font-weight: 600; margin-bottom: 5px;">¿Necesitas soporte para tu iglesia?
                </div>
                <div style="font-size: 11px; opacity: 0.95; line-height: 1.4;">Asesoría, instalación y capacitación para
                    departamentos de multimedia</div>
            </div>

        </div>
    </div>

    <!-- MODAL DE RECURSOS Y RESPONSABILIDAD -->
    <div id="resourcesModal" class="modal-overlay" onclick="closeModal('resourcesModal')"
        style="display:none; position:fixed; inset:0; background: var(--modal-overlay); z-index:20000; align-items:center; justify-content:center; opacity:0;">

        <div class="glass-card modal-content-animated" onclick="event.stopPropagation()"
            style="background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 20px; padding: 25px; width: 95%; max-width: 650px; text-align: center; box-shadow: 0 40px 100px rgba(0,0,0,0.5); max-height: 90vh; display: flex; flex-direction: column;">

            <h2 style="margin: 0 0 10px 0; color: var(--text); font-size: 20px;">GESTIÓN DE CONTENIDO</h2>

            <div
                style="background: var(--active-bg); padding: 12px; border-radius: 10px; margin-bottom: 15px; text-align: left; border: 1px solid var(--card-border);">
                <p style="margin:0; font-size: 11px; color: var(--text-muted); line-height: 1.3;">
                    Para brindarte una mejor experiencia, puedes habilitar estos recursos adicionales. Al activarlos,
                    confirmas que cuentas con los permisos necesarios para su uso en tu comunidad.
                </p>
            </div>

            <div class="scroll-list" style="flex: 1; text-align: left; padding-right: 5px;">
                <!-- SECCIÓN CANTOS -->
                <div style="margin-bottom: 20px;">
                    <h3 style="font-size: 13px; margin-bottom: 8px; opacity: 0.7; letter-spacing: 1px;">BIBLIOTECA DE
                        CANTOS</h3>
                    <div id="songResourceItem"
                        style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 15px; display: flex; align-items: center; justify-content: space-between; gap: 15px;">
                        <div style="flex: 1;">
                            <div style="font-size: 14px; font-weight: 700;">Biblioteca Iglesia Zurisadai</div>
                            <div style="font-size: 11px; opacity: 0.6;">Habilita el cancionero oficial de la iglesia.
                            </div>
                        </div>
                        <button onclick="loadLibraryWithConsent()" class="primary"
                            style="padding: 8px 15px; font-size: 11px; letter-spacing: 0; background: var(--accent); border: none;">HABILITAR</button>
                    </div>
                </div>

                <!-- SECCIÓN BIBLIAS -->
                <div>
                    <h3 style="font-size: 13px; margin-bottom: 8px; opacity: 0.7; letter-spacing: 1px;">BIBLIAS
                        ADICIONALES</h3>
                    <div id="bibleResourcesList" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <!-- Se genera dinámicamente -->
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--card-border);">
                <button onclick="closeModal('resourcesModal')" class="secondary"
                    style="width: 100%; padding: 12px; border-radius: 10px;">CERRAR VENTANA</button>
            </div>
        </div>
    </div>

    <div id="connectivityModal" class="modal-overlay" onclick="closeModal('connectivityModal')"
        style="display:none; position:fixed; inset:0; background: var(--modal-overlay); z-index:20000; align-items:center; justify-content:center; opacity:0;">

        <div class="glass-card modal-content-animated" onclick="event.stopPropagation()"
            style="background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 20px; padding: clamp(15px, 2vh, 25px); width: 92%; max-width: 850px; text-align: center; box-shadow: 0 40px 100px rgba(0,0,0,0.5); max-height: 85vh; display: flex; flex-direction: column; overflow: hidden;">

            <!-- Header Dinámico -->
            <div style="flex-shrink: 0; margin-bottom: 20px;">
                <h2 style="margin: 0; font-size: 24px; color: var(--text);">Control & Conectividad</h2>
                <p id="roomStatusSub"
                    style="margin: 3px 0 0 0; font-size: 10px; color: #10b981; text-transform: uppercase; letter-spacing: 1px; transition: all 0.3s;">
                    Gestión de Acceso Remoto</p>
            </div>

            <div
                style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; flex: 1; overflow: hidden; text-align: left;">

                <!-- COLUMNA IZQUIERDA: ESTADO Y VISOR -->
                <div class="scroll-list" style="overflow-y: auto; padding-right: 10px;">
                    <!-- ESTADO DE SALA -->
                    <!-- SECCIÓN 1: VISOR (OBS / PROYECTOR) -->
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <div style="width: 6px; height: 6px; border-radius: 50%; background: var(--accent);"></div>
                            <label
                                style="font-size: 11px; color: var(--text); font-weight: 700; text-transform: uppercase; margin: 0;">Visor
                                de Proyección (OBS)</label>
                        </div>
                        <input type="text" id="visorLinkModal" readonly onclick="copyVisorLink()"
                            title="Click para copiar"
                            style="width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--card-border); color: var(--accent); padding: 10px; border-radius: 8px; font-family: monospace; font-size: 10px; text-align: center; cursor: pointer; transition: all 0.2s;">
                        <p
                            style="font-size: 8px; color: var(--text-muted); text-align: center; margin-top: 5px; opacity: 0.6;">
                            (Click en la URL para copiar)</p>
                    </div>


                    <!-- SECCIÓN 2: INTEGRACIÓN ZION CAST ELIMINADA (AHORA ES LOCAL) -->

                </div>

                <!-- COLUMNA DERECHA: CONTROL REMOTO -->
                <div
                    style="display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(255,255,255,0.02); border-radius: 12px; padding: 20px; border: 1px solid var(--card-border);">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px; width: 100%;">
                        <div style="width: 6px; height: 6px; border-radius: 50%; background: #CCFF00;"></div>
                        <label
                            style="font-size: 11px; color: var(--text); font-weight: 700; text-transform: uppercase; margin: 0;">Control
                            Remoto Teléfono</label>
                    </div>

                    <!-- QR CONTAINER -->
                    <div id="remoteQRContainer"
                        style="background: white; padding: 12px; border-radius: 12px; display: inline-block; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                        <div id="remoteQRCode"></div>
                    </div>

                    <div style="width: 100%;">
                        <p
                            style="font-size: 10px; color: var(--text-muted); line-height: 1.4; margin-bottom: 10px; text-align: center;">
                            Escanea el QR o usa el enlace:</p>
                        <input type="text" id="remoteLinkModal" readonly onclick="copyRemoteLink()"
                            title="Click para copiar"
                            style="width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--card-border); color: #CCFF00; padding: 10px; border-radius: 8px; font-family: monospace; font-size: 10px; text-align: center; cursor: pointer;">
                    </div>
                </div>
            </div>

            <button onclick="closeModal('connectivityModal')" class="secondary"
                style="width: 100%; padding: 12px; margin-top: 20px; flex-shrink: 0; border-radius: 12px; font-weight: 700;">Cerrar
                Ventana</button>
        </div>
    </div>

    <!-- FILA INFERIOR: OPCIONES PRO (Movida FUERA del layout para anclaje viewport real) -->
    <div class="glass-card col-options" id="optionsCard">
        <div style="display: flex; justify-content: center; align-items: center; cursor: pointer; height: 36px; width: 100%; position: absolute; top: -1px; left: 0; z-index: 10;"
            onclick="toggleOptionsPanel()">

            <!-- Título Centrado (Absolute Shield) -->
            <div
                style="margin: 0; padding: 0; font-size: 11px; letter-spacing: 2px; font-weight: 700; color: var(--section-header-text); pointer-events: none; text-align: center; text-transform: uppercase; display: flex; align-items: center; justify-content: center;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path
                        d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                    </path>
                </svg>
                CONFIGURACION
            </div>

            <!-- Flecha Derecha (Absolute Shield) -->
            <div
                style="position: absolute; right: 15px; top: 0; height: 100%; display: flex; align-items: center; opacity: 0.7; font-size: 10px;">
                <div>▼</div>
            </div>
        </div>
        <!-- Espaciador para no tapar el primer item al expandir -->
        <div style="height: 36px; width: 100%;"></div>

        <div id="overlayOptions" class="scroll-list"
            style="padding-top: 15px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; align-items: start;">

            <!-- COLUMNA 1: TIPOGRAFÍA -->
            <div
                style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.05);">
                <h3
                    style="margin: 0 0 15px 0; font-size: 12px; color: var(--section-header-text); text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px;">
                    Tipografía
                </h3>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div class="control-group">
                        <label>Fuente</label>
                        <select id="fontFamily" onchange="updateConfig()" style="width: 100%;">
                            <option value="system-ui, sans-serif">Sistema (Default)</option>
                            <!-- Google Fonts List -->
                            <option value="'Bad Script', cursive">Bad Script</option>
                            <option value="'Bebas Neue', sans-serif">Bebas Neue</option>
                            <option value="'BenchNine', sans-serif" selected>BenchNine</option>
                            <option value="'Dosis', sans-serif">Dosis</option>
                            <option value="'Kaushan Script', cursive">Kaushan Script</option>
                            <option value="'Lato', sans-serif">Lato</option>
                            <option value="'Oregano', cursive">Oregano</option>
                            <option value="'Oxanium', cursive">Oxanium</option>
                            <option value="'Play', sans-serif">Play</option>
                            <option value="'Quicksand', sans-serif">Quicksand</option>
                            <option value="'Raleway', sans-serif">Raleway</option>
                            <option value="'Roboto', sans-serif">Roboto</option>
                            <option value="'Tangerine', cursive">Tangerine</option>
                            <option value="'Viga', sans-serif">Viga</option>

                            <!-- Clásicas de Sistema (Alternativas) -->
                            <option value="'Arial Black', sans-serif">Arial Black</option>
                            <option value="Impact, sans-serif">Impact</option>
                            <option value="Georgia, serif">Georgia</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label>Estilo de Texto</label>
                        <div
                            style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;  padding: 10px; border-radius: 8px;">
                            <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                                <input type="checkbox" id="boldText" checked onchange="updateConfig()">
                                <span style="font-size:12px;">Negrilla</span>
                            </label>
                            <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                                <input type="checkbox" id="uppercase" onchange="updateConfig()">
                                <span style="font-size:12px;">Mayúsculas</span>
                            </label>
                            <label style="display:flex; align-items:center; gap:8px; cursor:pointer;"
                                title="Ajusta el tamaño automáticamente al texto">
                                <input type="checkbox" id="autoFit" checked onchange="updateConfig()">
                                <span style="font-size:12px;">Tamaño Auto.</span>
                            </label>
                            <div
                                style="grid-column: span 2; display: flex; flex-direction: column; gap: 5px; margin-top: 5px;">
                                <label
                                    style="font-size: 11px; opacity: 0.7; display: flex; justify-content: space-between;">
                                    TAMAÑO MÁXIMO <span id="maxFontSizeVal"
                                        style="color: var(--accent);">${document.getElementById('maxFontSize')?.value ||
                                        300}px</span>
                                </label>
                                <input type="range" id="maxFontSize" min="20" max="600" value="300"
                                    oninput="updateConfig(); document.getElementById('maxFontSizeVal').innerText = this.value + 'px'"
                                    style="width: 100%; margin: 0;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COLUMNA 2: COLORES -->
            <div
                style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.05);">
                <h3
                    style="margin: 0 0 15px 0; font-size: 12px; color: var(--section-header-text); text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px;">
                    Colores de Texto
                </h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="control-group">
                        <label>Letras</label>
                        <input type="color" id="textColor" value="#ffffff" oninput="updateConfig()"
                            style="height:36px; padding:2px; cursor:pointer;">
                    </div>
                    <div class="control-group">
                        <label>Sombra</label>
                        <input type="color" id="shadowColor" value="#000000" oninput="updateConfig()"
                            style="height:36px; padding:2px; cursor:pointer;">
                    </div>
                </div>

                <h3 style="margin: 15px 0 15px 0; font-size: 11px; opacity:0.6; text-transform: uppercase;">Color de
                    Acento</h3>
                <div id="colorGrid" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;">
                    <!-- Se llena con JS -->
                </div>
            </div>

            <!-- COLUMNA 2: ESTILO Y EFECTOS -->
            <div
                style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.05);">
                <h3
                    style="margin: 0 0 15px 0; font-size: 12px; color: var(--section-header-text); text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px;">
                    Estilo y Efectos
                </h3>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div class="control-group">
                        <label style="display: flex; justify-content: space-between;">Sombra Texto <span
                                id="textShadowVal" style="color: var(--accent);">10</span></label>
                        <input type="range" id="textShadow" min="0" max="50" value="10"
                            oninput="updateConfig(); document.getElementById('textShadowVal').innerText = this.value"
                            style="width: 100%;">
                    </div>

                    <div class="control-group">
                        <label style="display: flex; justify-content: space-between;">Margen Vertical <span
                                id="marginSizeVal" style="color: var(--accent);">50</span></label>
                        <input type="range" id="marginSize" min="0" max="200" value="50"
                            oninput="updateConfig(); document.getElementById('marginSizeVal').innerText = this.value"
                            style="width: 100%;">
                    </div>

                    <div class="control-group">
                        <label style="display: flex; justify-content: space-between;">Margen Horizontal <span
                                id="marginSizeXVal" style="color: var(--accent);">80</span></label>
                        <input type="range" id="marginSizeX" min="0" max="300" value="80"
                            oninput="updateConfig(); document.getElementById('marginSizeXVal').innerText = this.value"
                            style="width: 100%;">
                    </div>

                    <div class="control-group">
                        <label style="display: flex; justify-content: space-between;">Interlineado <span
                                id="lineHeightVal" style="color: var(--accent);">0.95</span></label>
                        <input type="range" id="lineHeight" min="0.7" max="1.5" step="0.05" value="0.95"
                            oninput="updateConfig(); document.getElementById('lineHeightVal').innerText = this.value"
                            style="width: 100%;">
                    </div>

                    <div class="control-group">
                        <label>Transición</label>
                        <select id="transitionEffect" onchange="updateConfig()" style="width: 100%;">
                            <option value="zoom" selected>Zoom</option>
                            <option value="fade">Desvanecer (Fade)</option>
                            <option value="slide-up">Wipe Up (Revelación)</option>
                            <option value="slide-left">Spiral In (Espiral)</option>
                            <option value="slide-right">Lens Flare (Destello)</option>
                            <option value="rotate-in">Rotación 3D</option>
                            <option value="blur-fade">Particle Burst (Explosión)</option>
                            <option value="elastic">Liquid Morph (Líquido)</option>
                            <option value="zoom-rotate">Gravity Drop (Caída)</option>
                            <option value="none">Corte Directo</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label>Velocidad de Animación <span id="transitionDurationValue"
                                style="font-weight: 600; color: var(--accent);">1.0s</span></label>
                        <input type="range" id="transitionDuration" min="0.3" max="2.0" step="0.1" value="1.0"
                            oninput="updateConfig(); document.getElementById('transitionDurationValue').textContent = this.value + 's'"
                            style="width: 100%;">
                        <div
                            style="display: flex; justify-content: space-between; font-size: 9px; opacity: 0.5; margin-top: 2px;">
                            <span>Rápido (0.3s)</span>
                            <span>Lento (2.0s)</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COLUMNA 3: FONDO -->
            <div
                style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.05);">
                <h3
                    style="margin: 0 0 15px 0; font-size: 12px; color: var(--section-header-text); text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px;">
                    Fondo
                </h3>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div class="control-group">
                        <label>Imagen de Fondo</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="file" id="bgInput" accept="image/*,video/mp4,video/webm"
                                onchange="uploadBackground(this)">
                            <button class="danger" onclick="clearBackground()">Quitar Fondo</button>
                        </div>
                        <div
                            style="margin-top: 5px; display: flex; align-items: center; gap: 8px; padding: 4px; border-radius: 4px; ">
                            <div id="bgPreviewThumb"
                                style="width: 24px; height: 14px; background: #222; border-radius: 2px; background-size: cover; background-position: center;">
                            </div>
                            <span id="bgPreviewText" style="font-size: 10px; color: #666;">Sin fondo</span>
                        </div>

                        <!-- Botón Unsplash -->
                        <button onclick="toggleUnsplashPanel()"
                            style="width: 100%; margin-top: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: transform 0.2s;">
                            Buscar en Unsplash
                        </button>
                    </div>

                    <div class="control-group">
                        <label style="display: flex; justify-content: space-between;">Oscurecer Fondo (%) <span
                                id="bgDimVal" style="color: var(--accent);">0%</span></label>
                        <input type="range" id="bgDim" min="0" max="90" value="0"
                            oninput="updateConfig(); document.getElementById('bgDimVal').innerText = this.value + '%'"
                            style="width: 100%;">
                    </div>

                    <div class="control-group">
                        <label style="display: flex; justify-content: space-between;">Desenfoque (Blur) <span
                                id="bgBlurVal" style="color: var(--accent);">0px</span></label>
                        <input type="range" id="bgBlur" min="0" max="20" value="0"
                            oninput="updateConfig(); document.getElementById('bgBlurVal').innerText = this.value + 'px'"
                            style="width: 100%;">
                    </div>
                </div>
            </div>

        </div>

    </div>
    </div>

    <!-- MODAL UNSPLASH -->
    <div id="unsplashModal" onclick="if(event.target === this) toggleUnsplashPanel()"
        style="display:none; position:fixed; inset:0; background: rgba(0,0,0,0.85); backdrop-filter:blur(10px); z-index:10000; align-items:center; justify-content:center; padding: 10px;">

        <div onclick="event.stopPropagation()"
            style="background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 16px; padding: clamp(15px, 3vw, 30px); width: 100%; max-width: 800px; height: 90vh; max-height: 700px; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">

            <!-- Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0; font-size: clamp(16px, 4vw, 20px); color: var(--text);">Fondos Unsplash</h2>
                <button onclick="toggleUnsplashPanel()" class="btn-close-modal" title="Cerrar (Esc)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
                        stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <!-- Search -->
            <div style="margin-bottom: 15px;">
                <div style="display: flex; gap: 8px; width: 100%;">
                    <div style="position: relative; flex: 1;">
                        <input type="text" id="unsplash-search-input" placeholder="Buscar..."
                            style="width: 100%; padding: 8px 35px 8px 10px; border-radius: 8px; border: 1px solid var(--card-border);  color: var(--text); font-size: 14px;">
                        <button id="clearUnsplashSearchBtn" class="btn-clear-input" style="display: none;"
                            onclick="document.getElementById('unsplash-search-input').value=''; this.style.display='none'; searchUnsplash(); document.getElementById('unsplash-search-input').focus();">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    <button id="unsplash-search-btn" onclick="searchUnsplash()"
                        style="padding: 8px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; font-size: 14px; white-space: nowrap;">
                        Buscar
                    </button>
                </div>

                <!-- Categorías -->
                <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px;">
                    <button onclick="quickSearch('nature')"
                        style="font-size: 12px; padding: 6px 10px;">Naturaleza</button>
                    <button onclick="quickSearch('church')" style="font-size: 12px; padding: 6px 10px;">Iglesia</button>
                    <button onclick="quickSearch('worship')"
                        style="font-size: 12px; padding: 6px 10px;">Adoración</button>
                    <button onclick="quickSearch('sky')" style="font-size: 12px; padding: 6px 10px;">Cielos</button>
                    <button onclick="quickSearch('ocean')" style="font-size: 12px; padding: 6px 10px;">Océanos</button>
                    <button onclick="quickSearch('mountain')"
                        style="font-size: 12px; padding: 6px 10px;">Montañas</button>
                </div>
            </div>

            <!-- Loading -->
            <div id="unsplash-loading"
                style="display: none; text-align: center; padding: 40px; color: var(--text-muted);">
                Cargando...
            </div>

            <!-- Gallery (Responsive Grid) -->
            <div id="unsplash-gallery" style="flex: 1; overflow-y: auto; display: grid; gap: 8px; padding: 2px;">
            </div>

            <!-- Pagination -->
            <div id="unsplash-pagination"
                style="display: none; justify-content: center; align-items: center; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                <button id="prev-page" onclick="changePage(-1)" style="font-size: 13px; padding: 6px 12px;">←
                    Anterior</button>
                <span id="page-info" style="color: var(--text); font-size: 13px;">Página 1</span>
                <button id="next-page" onclick="changePage(1)" style="font-size: 13px; padding: 6px 12px;">Siguiente
                    →</button>
            </div>
        </div>
    </div>

    <!-- Estilos para Modal Unsplash -->
    <style>
        /* Cards de Unsplash */
        .unsplash-image-card {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            aspect-ratio: 1;
        }

        .unsplash-image-card:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .unsplash-image-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .unsplash-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
            opacity: 0;
            transition: opacity 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 10px;
        }

        .unsplash-image-card:hover .unsplash-overlay {
            opacity: 1;
        }

        .clean-apply-btn {
            background: white;
            color: #333;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 5px;
        }

        .clean-credit {
            font-size: 10px;
            color: white;
            margin: 0;
        }

        .clean-credit a {
            color: #667eea;
            text-decoration: none;
        }

        /* Estilos para Modo Claro */
        body.light-theme #unsplashModal>div {
            background: #f5f5f5 !important;
            border-color: #ddd !important;
        }

        body.light-theme #unsplashModal h2 {
            color: #222 !important;
        }

        body.light-theme #unsplash-search-input {
            background: white !important;
            color: #222 !important;
            border-color: #ccc !important;
        }

        body.light-theme #unsplash-search-input::placeholder {
            color: #999 !important;
        }

        body.light-theme #unsplashModal button {
            color: #666 !important;
        }

        body.light-theme #unsplash-loading,
        body.light-theme #page-info {
            color: #666 !important;
        }

        /* Grid por defecto (Desktop) */
        #unsplash-gallery {
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)) !important;
            grid-auto-rows: min-content !important;
        }

        /* Media Queries para Responsividad */
        @media (max-width: 768px) {
            #unsplash-gallery {
                grid-template-columns: repeat(3, 1fr) !important;
            }
        }
    </style>

    <!-- Scripts de Unsplash -->
    <script>
        let currentPage = 1;
        let currentQuery = '';
        let totalPages = 1;

        function toggleUnsplashPanel() {
            const modal = document.getElementById('unsplashModal');
            if (modal.style.display === 'none') {
                modal.style.display = 'flex';
                // Cambio: Buscar 'worship' automáticamente al abrir
                quickSearch('worship');
            } else {
                modal.style.display = 'none';
            }
        }

        async function loadCurated() {
            const loading = document.getElementById('unsplash-loading');
            const gallery = document.getElementById('unsplash-gallery');

            loading.style.display = 'block';
            gallery.innerHTML = '';

            try {
                const images = await unsplashAPI.getCurated(1, 12);
                gallery.innerHTML = images.map(img => `
                    <div onclick="applyUnsplashBackground('${img.urls.regular}')" 
                        style="cursor: pointer; border-radius: 8px; overflow: hidden; position: relative; aspect-ratio: 1; background: url('${img.urls.small}') center/cover;">
                        <div style="position: absolute; inset: 0; background: rgba(0,0,0,0.4); opacity: 0; transition: opacity 0.2s; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;"
                            onmouseenter="this.style.opacity='1'" onmouseleave="this.style.opacity='0'">
                            ✓
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                gallery.innerHTML = `<p style="color: var(--text); text-align: center; grid-column: 1/-1;">Error al cargar imágenes</p>`;
            }

            loading.style.display = 'none';
        }

        async function searchUnsplash() {
            const query = document.getElementById('unsplash-search-input').value.trim();
            if (!query) return;

            currentQuery = query;
            currentPage = 1;
            await performSearch();
        }

        async function quickSearch(query) {
            document.getElementById('unsplash-search-input').value = query;
            currentQuery = query;
            currentPage = 1;
            await performSearch();
        }

        async function performSearch() {
            const loading = document.getElementById('unsplash-loading');
            const gallery = document.getElementById('unsplash-gallery');
            const pagination = document.getElementById('unsplash-pagination');

            loading.style.display = 'block';
            gallery.innerHTML = '';

            try {
                const data = await unsplashAPI.search(currentQuery, currentPage, 12);
                totalPages = data.totalPages;

                gallery.innerHTML = data.results.map(img => `
                    <div onclick="applyUnsplashBackground('${img.urls.regular}')" 
                        style="cursor: pointer; border-radius: 8px; overflow: hidden; position: relative; aspect-ratio: 1; background: url('${img.urls.small}') center/cover;">
                        <div style="position: absolute; inset: 0; background: rgba(0,0,0,0.4); opacity: 0; transition: opacity 0.2s; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;"
                            onmouseenter="this.style.opacity='1'" onmouseleave="this.style.opacity='0'">
                            ✓
                        </div>
                    </div>
                `).join('');

                // Actualizar paginación
                document.getElementById('page-info').textContent = `Página ${currentPage} de ${totalPages}`;
                document.getElementById('prev-page').disabled = currentPage <= 1;
                document.getElementById('next-page').disabled = currentPage >= totalPages;
                pagination.style.display = totalPages > 1 ? 'flex' : 'none';

            } catch (error) {
                gallery.innerHTML = `<p style="color: var(--text); text-align: center; grid-column: 1/-1;">Error: ${error.message}</p>`;
            }

            loading.style.display = 'none';
        }

        function changePage(delta) {
            currentPage += delta;
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;
            performSearch();
        }

        // Permitir buscar con Enter
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('unsplash-search-input');
            const clearBtn = document.getElementById('clearUnsplashSearchBtn');
            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') searchUnsplash();
                });
                searchInput.addEventListener('input', () => {
                    if (clearBtn) clearBtn.style.display = searchInput.value ? 'flex' : 'none';
                });
            }
        });

        // Canal Global (con Room Code para evitar interferencia entre salas)
        let broadcastChannel = null;

        // Inicializar room automáticamente al cargar
        document.addEventListener('DOMContentLoaded', () => {
            // En modo LOCAL (Instalador), siempre es GLOBAL
            window.zionRoomCode = 'GLOBAL';
            localStorage.setItem('zion_panel_room', 'GLOBAL');

            // Inicializar BroadcastChannel (Modo Local Fijo)
            if (typeof BroadcastChannel !== 'undefined') {
                try {
                    const channelName = 'zion-presenter-local';
                    broadcastChannel = new BroadcastChannel(channelName);
                    window.displayChannel = broadcastChannel;
                    console.log(`📡 BroadcastChannel local listo: ${channelName}`);
                } catch (e) {
                    console.warn('BroadcastChannel no disponible:', e);
                }
            }

            // Crear URL del visor de forma asíncrona para detectar IP
            (async () => {
                let baseURL = window.location.origin === 'null' || !window.location.origin ? '' : window.location.origin;
                try {
                    const resp = await fetch('/api/network-info');
                    const net = await resp.json();
                    if (net.success && net.primaryIp) {
                        baseURL = `http://${net.primaryIp}:${net.port}`;
                    }
                } catch (e) {
                    console.warn("Error detectando IP inicial:", e);
                }

                const visorURL = `${baseURL}/v/GLOBAL`;
                const visorLinkInput = document.getElementById('visorLinkModal');
                if (visorLinkInput) {
                    visorLinkInput.value = visorURL;
                }
            })();
        });

        // Copiar enlace del visor
        function copyVisorLink() {
            const input = document.getElementById('visorLinkModal');
            if (!input) return;

            input.select();
            input.setSelectionRange(0, 99999);

            try {
                document.execCommand('copy');
                const statusSub = document.getElementById('roomStatusSub');
                if (statusSub) {
                    const originalText = statusSub.textContent;
                    statusSub.textContent = '¡ENLACE COPIADO!';
                    statusSub.style.color = '#fff';

                    setTimeout(() => {
                        if (statusSub) {
                            statusSub.textContent = originalText;
                            statusSub.style.color = '#10b981';
                        }
                    }, 2000);
                }
            } catch (err) {
                console.error('Error al copiar:', err);
            }
        }

        // Escuchar confirmación del servidor
        if (typeof socket !== 'undefined' && socket) {
            socket.on('room_joined', (data) => {
                console.log(`Confirmación del sistema: ${data.roomCode}`);
            });
        }

        // FUNCIÓN PARA ACTUALIZAR TICKER
        function updateTicker() {
            const enabled = window.tickerEnabled !== undefined ? window.tickerEnabled : false;
            const text = document.getElementById('tickerText')?.value || '';
            const speed = parseInt(document.getElementById('tickerSpeed')?.value || 5);
            const sizeElement = document.getElementById('tickerSize');
            const size = sizeElement ? parseInt(sizeElement.value) : 3; // Default: 3 (Grande)
            const position = document.getElementById('tickerPosition')?.value || 'bottom';

            console.log('Ticker Update:', { enabled, text, speed, size, position });

            if (typeof bc !== 'undefined') {
                bc.postMessage({
                    type: 'ticker',
                    payload: {
                        enabled: enabled,
                        text: text,
                        speed: speed,
                        size: size,
                        position: position
                    }
                });
            }
        }

        // Función para abrir/cerrar modal de contacto
        function toggleContactModal() {
            const modal = document.getElementById('contactModal');
            if (!modal.classList.contains('active')) {
                modal.style.display = 'flex';
                void modal.offsetWidth;
                modal.classList.add('active');
            } else {
                closeModal('contactModal');
            }
        }

        window.toggleResourcesModal = function () {
            const modal = document.getElementById('resourcesModal');
            if (!modal.classList.contains('active')) {
                modal.style.display = 'flex';
                void modal.offsetWidth;
                modal.classList.add('active');
                renderSongResource(); // Cargar estado de cantos
                renderBibleResources(); // Cargar lista de biblias
            } else {
                closeModal('resourcesModal');
            }
        };

        window.renderSongResource = function () {
            const container = document.getElementById('songResourceItem');
            if (!container) return;

            const isLoaded = localStorage.getItem('zion_library_loaded') === 'true';

            if (isLoaded) {
                container.innerHTML = `
                    <div style="flex: 1;">
                        <div style="font-size: 14px; font-weight: 700;">Biblioteca Iglesia Zurisadai</div>
                        <div style="font-size: 11px; opacity: 0.6; color: var(--success);">El cancionero ha sido habilitado correctamente.</div>
                    </div>
                    <button class="secondary" style="padding: 8px 15px; font-size: 11px; pointer-events: none; opacity: 0.7; border-color: var(--success); color: var(--success);">HABILITADO</button>
                `;
            } else {
                container.innerHTML = `
                    <div style="flex: 1;">
                        <div style="font-size: 14px; font-weight: 700;">Biblioteca Iglesia Zurisadai</div>
                        <div style="font-size: 11px; opacity: 0.6;">Habilita el cancionero oficial de la iglesia.</div>
                    </div>
                    <button onclick="loadLibraryWithConsent()" class="primary" style="padding: 8px 15px; font-size: 11px; letter-spacing: 0; background: var(--accent); border: none;">HABILITAR</button>
                `;
            }
        };

        window.renderBibleResources = function () {
            const list = document.getElementById('bibleResourcesList');
            if (!list || typeof BIBLE_VERSIONS === 'undefined') return;

            list.innerHTML = Object.entries(BIBLE_VERSIONS)
                .filter(([id, info]) => info.hasCopy)
                .map(([id, info]) => {
                    const active = isBibleUnlocked(id);
                    return `
                        <div style="background: rgba(255,255,255,0.03); border: 1px solid ${active ? 'rgba(16,185,129,0.3)' : 'var(--card-border)'}; border-radius: 8px; padding: 10px; display: flex; align-items: center; justify-content: space-between; gap: 10px;">
                            <div style="flex: 1; overflow: hidden;">
                                <div style="font-size: 12px; font-weight: 700; white-space: nowrap; text-overflow: ellipsis; overflow: hidden;">${info.name}</div>
                                <div style="font-size: 9px; opacity: 0.5;">${active ? 'ACTIVADA' : 'CON COPYRIGHT'}</div>
                            </div>
                            <button onclick="toggleBibleInModal('${id}')" 
                                    style="padding: 4px 8px; font-size: 10px; min-width: 60px; border-radius: 5px; border: 1px solid ${active ? 'var(--success)' : 'var(--accent)'}; background: ${active ? 'rgba(34,197,94,0.1)' : 'transparent'}; color: ${active ? 'var(--success)' : 'var(--accent)'}; cursor: pointer;">
                                ${active ? 'QUITAR' : 'ACTIVAR'}
                            </button>
                        </div>
                    `;
                }).join('');
        }

        window.toggleBibleInModal = function (id) {
            const unlocked = JSON.parse(localStorage.getItem('zion_unlocked_bibles') || '[]');
            if (unlocked.includes(id)) {
                // Quitar
                const newUnlocked = unlocked.filter(bid => bid !== id);
                localStorage.setItem('zion_unlocked_bibles', JSON.stringify(newUnlocked));
            } else {
                // Activar directamente sin confirmación
                unlocked.push(id);
                localStorage.setItem('zion_unlocked_bibles', JSON.stringify(unlocked));
            }

            // Actualizar interfaz
            if (typeof updateBibleSelects === 'function') updateBibleSelects();
            renderBibleResources();
        };

        // --- INTEGRACIÓN ZION CAST (IMPLEMENTADO EN js/main.js) ---
        // Ya no es necesario re-definirlo aquí para evitar conflictos.

        // Interceptar showRemoteQR para cargar datos
        const originalShowRemoteQR = window.showRemoteQR;
        window.showRemoteQR = async function () {
            if (typeof originalShowRemoteQR === 'function') await originalShowRemoteQR();
            const savedUrl = localStorage.getItem('zion_cast_integration_url');
            if (savedUrl) {
                setTimeout(() => {
                    const input = document.getElementById('zionCastUrlInput');
                    if (input) input.value = savedUrl;
                }, 100);
            }
        };
    </script>



    <script>
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal('aboutModal');
                closeModal('contactModal');
                closeModal('resourcesModal');
                const flyer = document.getElementById('zionFlyerModal');
                if (flyer) flyer.style.display = 'none';
            }
        });

        // Cerrar panel de configuración al hacer clic fuera
        document.addEventListener('click', (e) => {
            const optionsCard = document.getElementById('optionsCard');
            if (optionsCard && optionsCard.classList.contains('expanded')) {
                // Si el clic fue FUERA del panel de opciones
                // Y NO fue dentro de elementos del tutorial
                const tutorialOverlay = document.getElementById('zion-tutorial-overlay');
                const isTutorialClick = tutorialOverlay && tutorialOverlay.contains(e.target);

                if (!optionsCard.contains(e.target) && !isTutorialClick) {
                    if (typeof toggleOptionsPanel === 'function') {
                        toggleOptionsPanel(false); // Forzar cierre
                    }
                }
            }
        });
    </script>

    <!-- VISTA DE ZION CAST (Panel de Control) - FUERA DE LA REJILLA PARA FULL SCREEN -->
    <div id="castView" style="display: none;">
        <!-- Se inyecta dinámicamente -->
    </div>

    <div class="yael-signature">By Yael Gtz</div>
</body>

</html>