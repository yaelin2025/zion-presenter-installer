<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>Zion Remote • Control</title>
    <link rel="icon" type="image/png" href="../img/favicon.png">
    <link rel="apple-touch-icon" href="../img/favicon.png">
    <link rel="manifest" href="../manifest.json">

    <!-- Fonts -->
    <link href="../css/fonts.css" rel="stylesheet">

    <style>
        :root {
            --accent: #0ea5e9;
            --accent-glow: rgba(14, 165, 233, 0.4);
            --bg: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --card-border: rgba(255, 255, 255, 0.1);
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        body {
            background-color: var(--bg);
            background-image:
                radial-gradient(circle at 0% 0%, rgba(14, 165, 233, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 100% 100%, rgba(139, 92, 246, 0.15) 0%, transparent 50%);
            background-attachment: fixed;
            min-height: 100vh;
            color: var(--text);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }

        /* Ambient Glow */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            opacity: 0.03;
            pointer-events: none;
            z-index: 100;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding-bottom: calc(var(--safe-bottom) + 30px);
        }

        /* HEADER */
        header {
            padding: calc(var(--safe-top) + 12px) 20px 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--card-border);
            z-index: 10;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand img {
            width: 32px;
            height: 32px;
            object-fit: contain;
            filter: drop-shadow(0 0 8px var(--accent-glow));
        }

        .brand-info h1 {
            font-size: 16px;
            font-weight: 800;
            letter-spacing: 1px;
            line-height: 1;
        }

        .brand-info p {
            font-size: 9px;
            letter-spacing: 2px;
            color: var(--accent);
            text-transform: uppercase;
            font-weight: 600;
        }

        .connection-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .room-badge {
            background: rgba(14, 165, 233, 0.1);
            border: 1px solid rgba(14, 165, 233, 0.3);
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1px;
            color: var(--accent);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            color: var(--text-muted);
        }

        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #64748b;
        }

        .dot.online {
            background: #10b981;
            box-shadow: 0 0 10px #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.3);
                opacity: 0.7;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* MAIN CONTENT */
        main {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* LIVE PREVIEW CARD */
        .live-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            padding: 20px;
            height: 340px;
            /* Tamaño fijo para evitar saltos */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
        }

        .live-card::before {
            content: 'LIVE PREVIEW';
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 8px;
            font-weight: 800;
            color: var(--accent);
            opacity: 0.5;
            letter-spacing: 2px;
        }

        #liveContent {
            font-size: 18px;
            font-weight: 600;
            line-height: 1.4;
            max-width: 100%;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            line-clamp: 4;
            -webkit-box-orient: vertical;
            overflow: hidden;
            color: var(--text);
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .placeholder-logo {
            opacity: 0.2;
            width: 80px;
            filter: grayscale(1);
        }

        /* SLIDERS QUICK CONTROL */
        .quick-sliders {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 18px;
            border: 1px solid var(--card-border);
        }

        .slider-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .slider-group svg {
            width: 18px;
            height: 18px;
            color: var(--accent);
            opacity: 0.8;
        }

        .mobile-slider {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
        }

        .mobile-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px var(--accent);
        }

        /* CONTROLS GRID */
        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            flex: 1;
        }

        .control-btn {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 24px;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .control-btn::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.05), transparent);
            transform: rotate(45deg);
            transition: 0.5s;
            pointer-events: none;
        }

        .control-btn:active::after {
            left: 100%;
        }

        .control-btn:active {
            transform: scale(0.92);
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        .control-btn.primary {
            grid-column: span 2;
            background: linear-gradient(135deg, var(--accent) 0%, #3b82f6 100%);
            border: none;
            box-shadow: 0 10px 25px rgba(14, 165, 233, 0.3);
        }

        .control-btn.primary:active {
            box-shadow: 0 5px 15px rgba(14, 165, 233, 0.2);
        }

        .control-btn.danger {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .control-btn.danger svg {
            filter: drop-shadow(0 0 5px rgba(239, 68, 68, 0.4));
        }

        .btn-label {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.9;
        }

        .btn-icon-svg {
            width: 32px;
            height: 32px;
            opacity: 1;
        }

        /* FOOTER ACTIONS */
        .footer-actions {
            padding: 20px;
            display: flex;
            justify-content: space-around;
            background: rgba(15, 23, 42, 0.5);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--card-border);
        }

        .action-icon-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            font-weight: 600;
        }

        .action-icon-btn.active {
            color: var(--accent);
        }

        .action-icon-svg {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .action-icon-btn.active .action-icon-svg {
            opacity: 1;
        }

        /* MODALS / OVERLAYS */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: calc(var(--safe-top) + 15px) 20px 40px 20px;
            text-align: center;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .overlay.active {
            transform: translateY(0);
        }

        .input-group {
            width: 100%;
            max-width: 300px;
            margin-top: 20px;
        }

        .room-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--card-border);
            border-radius: 12px;
            padding: 15px;
            color: white;
            font-size: 24px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 8px;
            margin-bottom: 20px;
        }

        .room-input:focus {
            outline: none;
            border-color: var(--accent);
            background: rgba(255, 255, 255, 0.1);
        }

        .save-btn {
            width: 100%;
            background: var(--accent);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* HAPTIC / RIPPLE EFFECT */
        .ripple {
            position: absolute;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: scale(0);
            animation: ripple-animation 0.5s linear;
            pointer-events: none;
        }

        @keyframes ripple-animation {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* BIBLE SELECTOR MODAL */
        .bible-grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(95px, 1fr));
            gap: 10px;
            width: 100%;
            max-height: 70vh;
            overflow-y: auto;
            padding: 10px;
        }

        .bible-grid-container.numbers {
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        }

        .grid-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 10px 5px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 55px;
            word-break: break-word;
            line-height: 1.2;
        }

        .grid-item:active {
            background: var(--accent);
            transform: scale(0.95);
        }

        .modal-header-nav {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--card-border);
            width: 100%;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* DARK MODE OPTIMIZATION */
        @media (prefers-color-scheme: light) {
            /* We keep it dark as part of the brand identity */
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- HEADER -->
        <header>
            <div class="brand">
                <img src="../img/solologo.png" alt="Zion">
                <div class="brand-info">
                    <h1>ZION</h1>
                    <p>Presenter</p>
                </div>
            </div>
            <div class="connection-status">
                <div id="roomBadge" class="room-badge">GLOBAL</div>
                <div class="status-indicator">
                    <span id="statusText">CONECTANDO</span>
                    <div id="statusDot" class="dot"></div>
                </div>
            </div>
            <a href="../guia.html" id="helpLink"
                style="color: var(--text-muted); padding: 5px; margin-left: 10px; display: flex; align-items: center; text-decoration: none;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
            </a>
        </header>

        <!-- MAIN -->
        <main>
            <!-- LIVE PREVIEW CARD -->
            <div class="live-card" id="liveCard">
                <div id="liveBg"
                    style="position: absolute; inset: 0; z-index: 0; background-size: cover; background-position: center; transition: all 0.5s; opacity: 0.3;">
                </div>

                <!-- Info Arriba -->
                <div style="width: 100%; position: relative; z-index: 1;">
                    <div id="prevPhraseContainer"
                        style="margin-bottom: 8px; padding: 5px 10px; background: rgba(0,0,0,0.25); border-radius: 6px; width: 100%; display: none;">
                        <div id="prevPhrase"
                            style="font-size: 11px; color: rgba(255,255,255,0.6); font-style: italic; white-space: pre-wrap; text-shadow: 0 1px 2px rgba(0,0,0,0.8);">
                        </div>
                    </div>
                    <div id="liveSongTitle"
                        style="font-size: 14px; font-weight: 700; color: #ffffff; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">
                        ZION PRESENTER</div>
                </div>

                <!-- Contenido Central -->
                <div id="liveContent"
                    style="position: relative; z-index: 1; flex: 1; display: flex; align-items: center; justify-content: center; padding: 10px 0; width: 100%; white-space: pre-wrap;">
                    <img src="../img/solologo.png" class="placeholder-logo" alt="">
                </div>

                <!-- Info Abajo -->
                <div id="nextPhraseContainer"
                    style="position: relative; z-index: 1; margin-top: 8px; padding: 6px 10px; background: rgba(0,0,0,0.3); border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); width: 100%; display: none;">
                    <div id="nextPhrase"
                        style="font-size: 13px; color: #fff; font-style: italic; white-space: pre-wrap; text-shadow: 0 1px 4px rgba(0,0,0,0.8);">
                    </div>
                </div>
            </div>

            <!-- QUICK SLIDERS -->
            <div class="quick-sliders">
                <div class="slider-group">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5" />
                        <line x1="12" y1="1" x2="12" y2="3" />
                        <line x1="12" y1="21" x2="12" y2="23" />
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
                        <line x1="1" y1="12" x2="3" y2="12" />
                        <line x1="21" y1="12" x2="23" y2="12" />
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                    <input type="range" id="dimSlider" class="mobile-slider" min="0" max="100" value="0"
                        oninput="sendQuickConfig()">
                </div>
            </div>

            <!-- BIBLE SELECTOR TRIGGER -->
            <button class="control-btn primary"
                style="width: 100%; height: 50px; margin-bottom: 15px; border-radius: 15px; flex-direction: row; gap: 10px;"
                onclick="openBibleSelector()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                </svg>
                SELECCIONAR BIBLIA
            </button>

            <!-- CONTROLS -->
            <div class="controls-grid">
                <button class="control-btn primary" id="btnNext" onclick="sendCommand('next')" disabled>
                    <svg class="btn-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                        stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                    <span class="btn-label">Siguiente</span>
                </button>

                <button class="control-btn" id="btnPrev" onclick="sendCommand('prev')" disabled>
                    <svg class="btn-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                        stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    <span class="btn-label">Anterior</span>
                </button>

                <button class="control-btn danger" id="btnBlackout" onclick="sendCommand('blackout')" disabled>
                    <svg class="btn-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                        stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                    </svg>
                    <span class="btn-label">Limpiar</span>
                </button>
            </div>
        </main>


    </div>

    <!-- BIBLE SELECTOR OVERLAY -->
    <div class="overlay" id="bibleOverlay">
        <div class="modal-header-nav">
            <button id="bibleBackBtn" class="back-btn" onclick="goBackBibleStep()" style="display: none;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </button>
            <h2 id="bibleModalTitle">Libros</h2>
            <button class="back-btn" style="margin-left: auto; background: transparent;" onclick="closeBibleOverlay()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div id="bibleGrid" class="bible-grid-container">
            <!-- Dinámico -->
        </div>
    </div>


    <script src="../js/zion-analytics.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io({
            reconnection: true,
            reconnectionDelay: 1000,
            timeout: 20000
        });

        let currentRoom = null;
        let lastVibration = 0;

        // Init
        window.addEventListener('load', () => {
            connectToRoom('GLOBAL');

            // Bloqueo estricto de Zoom (gestos y doble toque)
            document.addEventListener('touchstart', (e) => {
                if (e.touches.length > 1) e.preventDefault();
            }, { passive: false });

            let lastTouchEnd = 0;
            document.addEventListener('touchend', (e) => {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) e.preventDefault();
                lastTouchEnd = now;
            }, false);
        });

        // Socket Events
        socket.on('connect', () => {
            updateStatus(true, 'CONECTADO');
            if (currentRoom) {
                socket.emit('join_room', { roomCode: currentRoom });
                // Solicitar estado inicial al unirse
                socket.emit('remote_action', {
                    type: 'viewer_status',
                    action: 'joined',
                    room: currentRoom
                });
            }
        });

        socket.on('disconnect', () => {
            updateStatus(false, 'DESCONECTADO');
            disableButtons();
        });

        // Escuchar actualizaciones de red para la previsualización en vivo
        socket.on('network_update', (data) => {

            if (data.type === 'slide' || data.type === 'text') {
                const payload = data.payload || {};
                updateLiveUI({
                    title: payload.title || payload.songTitle || 'ZION PRESENTER',
                    current: payload.currentText || payload.text || (payload.lines ? payload.lines[0] : ''),
                    next: payload.nextText || '',
                    prev: payload.prevText || ''
                });
            } else if (data.type === 'bg') {
                const payload = data.payload || {};
                if (data.action === 'clear') {
                    updateLiveBg(null);
                } else {
                    updateLiveBg(payload.image);
                }
            } else if (data.type === 'presentation') {
                const payload = data.payload || {};
                updateLiveUI({
                    title: 'DIAPOSITIVA',
                    current: `<img src="${payload.image}" style="width:100%; border-radius:8px; display:block;">`,
                    isHTML: true
                });
            } else if (data.type === 'config') {
                applyMonitorConfig(data.payload);
            } else if (data.type === 'nav' && data.action === 'blackout') {
                updateLiveUI({ title: 'ZION PRESENTER', current: '', next: '', prev: '' });
            }
        });

        function updateLiveBg(imageUrl) {
            const bgEl = document.getElementById('liveBg');
            if (imageUrl) {
                // Si es un path local, intentar cargarlo si estamos en la misma red o si es una URL base64/blob
                bgEl.style.backgroundImage = `url(${imageUrl})`;
            } else {
                bgEl.style.backgroundImage = 'none';
            }
        }

        function applyMonitorConfig(config) {
            const bgEl = document.getElementById('liveBg');
            const dimSlider = document.getElementById('dimSlider');

            if (!config || !bgEl) return;

            // Actualizar slider si viene de la red para que esté sincronizado
            if (dimSlider && !dimSlider.dataset.isDragging) dimSlider.value = config.bgDim || 0;

            // Aplicar Dim y Blur escalados para el mando
            const dim = (100 - (parseInt(config.bgDim) || 0)) / 100;
            const blur = (parseInt(config.bgBlur) || 0) * 0.5; // El desenfoque sigue aplicándose visualmente si el panel lo envía

            bgEl.style.opacity = dim;
            bgEl.style.filter = `blur(${blur}px)`;
        }

        function sendQuickConfig() {
            const dim = document.getElementById('dimSlider').value;

            // Marcar como "arrastrando" para evitar que la actualización de red resetee el slider mientras lo movemos
            const dimEl = document.getElementById('dimSlider');
            dimEl.dataset.isDragging = "true";

            clearTimeout(window.sliderTimeout);
            window.sliderTimeout = setTimeout(() => {
                dimEl.dataset.isDragging = "";
            }, 1000);

            socket.emit('remote_action', {
                type: 'remote_cmd',
                action: 'update_config',
                payload: {
                    bgDim: dim
                },
                room: currentRoom
            });

            // Feedback visual en el monitor móvil inmediato 
            // Obtenemos el blur actual del elemento para no perderlo al aplicar el nuevo dim
            const bgEl = document.getElementById('liveBg');
            const currentBlurMatch = bgEl.style.filter.match(/blur\((.*)px\)/);
            const currentBlur = currentBlurMatch ? parseFloat(currentBlurMatch[1]) : 0;

            applyMonitorConfig({ bgDim: dim, bgBlur: currentBlur * 2 }); // x2 para compensar el escalado 0.5 en apply

            if (navigator.vibrate) navigator.vibrate(5);
        }

        // --- BIBLE SELECTOR LOGIC ---
        let bibleStep = 'books'; // 'books', 'chapters', 'verses'
        let selectedBook = null;
        let selectedChapter = null;
        let fullBibleData = [];

        async function openBibleSelector() {
            document.getElementById('bibleOverlay').classList.add('active');
            bibleStep = 'books';
            renderBibleStep();

            // Solicitar datos si no los tenemos
            if (fullBibleData.length === 0) {
                socket.emit('remote_action', { type: 'request_data', room: currentRoom });
            }
        }

        function closeBibleOverlay() {
            document.getElementById('bibleOverlay').classList.remove('active');
        }

        function renderBibleStep() {
            const grid = document.getElementById('bibleGrid');
            const title = document.getElementById('bibleModalTitle');
            const backBtn = document.getElementById('bibleBackBtn');
            grid.innerHTML = '';

            if (bibleStep === 'books') {
                title.textContent = 'Libros';
                backBtn.style.display = 'none';
                grid.classList.remove('numbers'); // Columnas más anchas para nombres
                BIBLE_BOOKS_REMOTE.forEach((name, idx) => {
                    const item = document.createElement('div');
                    item.className = 'grid-item';
                    item.textContent = name;
                    item.onclick = () => {
                        selectedBook = name;
                        bibleStep = 'chapters';
                        renderBibleStep();
                        // Solicitar capítulos al panel
                        socket.emit('remote_action', {
                            type: 'remote_cmd',
                            action: 'bible_get_chapters',
                            payload: { book: name },
                            room: currentRoom
                        });
                    };
                    grid.appendChild(item);
                });
            } else if (bibleStep === 'chapters') {
                title.textContent = selectedBook;
                backBtn.style.display = 'flex';
                grid.classList.add('numbers'); // Columnas más estrechas para números
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align:center; padding:20px; opacity:0.5;">Cargando capítulos...</div>';
            } else if (bibleStep === 'verses') {
                title.textContent = `${selectedBook} ${selectedChapter}`;
                backBtn.style.display = 'flex';
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align:center; padding:20px; opacity:0.5;">Cargando versículos...</div>';
            }
        }

        function goBackBibleStep() {
            if (bibleStep === 'verses') bibleStep = 'chapters';
            else if (bibleStep === 'chapters') bibleStep = 'books';
            renderBibleStep();
        }

        const BIBLE_BOOKS_REMOTE = [
            "Génesis", "Éxodo", "Levítico", "Números", "Deuteronomio", "Josué", "Jueces", "Rut", "1 Samuel", "2 Samuel", "1 Reyes", "2 Reyes", "1 Crónicas", "2 Crónicas", "Esdras", "Nehemías", "Ester", "Job", "Salmos", "Proverbios", "Eclesiastés", "Cantares", "Isaías", "Jeremías", "Lamentaciones", "Ezequiel", "Daniel", "Oseas", "Joel", "Amós", "Abdías", "Jonás", "Miqueas", "Nahúm", "Habacuc", "Sofonías", "Hageo", "Zacarías", "Malaquías",
            "Mateo", "Marcos", "Lucas", "Juan", "Hechos", "Romanos", "1 Corintios", "2 Corintios", "Gálatas", "Efesios", "Filipenses", "Colosenses", "1 Tesalonicenses", "2 Tesalonicenses", "1 Timoteo", "2 Timoteo", "Tito", "Filemón", "Hebreos", "Santiago", "1 Pedro", "2 Pedro", "1 Juan", "2 Juan", "3 Juan", "Judas", "Apocalipsis"
        ];

        // Escuchar respuestas del panel para llenar el grid
        socket.on('network_update', (data) => {
            if (data.type === 'bible_data_response') {
                const grid = document.getElementById('bibleGrid');
                grid.innerHTML = '';

                if (data.action === 'chapters') {
                    for (let i = 1; i <= data.count; i++) {
                        const item = document.createElement('div');
                        item.className = 'grid-item';
                        item.textContent = i;
                        item.onclick = () => {
                            selectedChapter = i;
                            bibleStep = 'verses';
                            renderBibleStep();
                            socket.emit('remote_action', {
                                type: 'remote_cmd',
                                action: 'bible_get_verses',
                                payload: { book: selectedBook, chapter: i },
                                room: currentRoom
                            });
                        };
                        grid.appendChild(item);
                    }
                } else if (data.action === 'verses') {
                    for (let i = 1; i <= data.count; i++) {
                        const item = document.createElement('div');
                        item.className = 'grid-item';
                        item.textContent = i;
                        item.onclick = () => {
                            socket.emit('remote_action', {
                                type: 'remote_cmd',
                                action: 'bible_show_verse',
                                payload: { book: selectedBook, chapter: selectedChapter, verse: i },
                                room: currentRoom
                            });
                            if (navigator.vibrate) navigator.vibrate(20);
                            closeBibleOverlay();
                        };
                        grid.appendChild(item);
                    }
                }
            }
        });

        function connectToRoom(roomCode) {
            currentRoom = 'GLOBAL';
            document.getElementById('roomBadge').textContent = 'GLOBAL';

            if (socket.connected) {
                socket.emit('join_room', { roomCode: 'GLOBAL' });
                // Solicitar estado inicial al unirse
                socket.emit('remote_action', {
                    type: 'viewer_status',
                    action: 'joined',
                    room: 'GLOBAL'
                });
            }

            enableButtons();
        }

        function sendCommand(cmd) {
            if (!currentRoom) return;

            socket.emit('remote_action', {
                type: 'remote_cmd',
                action: cmd,
                room: currentRoom
            });

            // Haptic Feedback
            if (navigator.vibrate) {
                const now = Date.now();
                if (now - lastVibration > 100) {
                    navigator.vibrate(40);
                    lastVibration = now;
                }
            }

            // Visual feedback - Temporary glow
            const btn = event.currentTarget;
            createRipple(event);
        }

        function toggleMode() {
            if (!currentRoom) return;
            socket.emit('remote_action', {
                type: 'remote_cmd',
                action: 'toggle_mode', // Define this in main.js if needed
                room: currentRoom
            });
            if (navigator.vibrate) navigator.vibrate([30, 50]);
        }

        function updateLiveUI(data) {
            const titleEl = document.getElementById('liveSongTitle');
            const contentEl = document.getElementById('liveContent');
            const nextContainer = document.getElementById('nextPhraseContainer');
            const nextEl = document.getElementById('nextPhrase');
            const prevContainer = document.getElementById('prevPhraseContainer');
            const prevEl = document.getElementById('prevPhrase');

            titleEl.textContent = data.title || 'ZION PRESENTER';

            if (!data.current || (typeof data.current === 'string' && (data.current.includes('ZION') && data.current.includes('PRESENTER')))) {
                contentEl.innerHTML = `<img src="../img/solologo.png" class="placeholder-logo" alt="">`;
                nextContainer.style.display = 'none';
                prevContainer.style.display = 'none';
            } else {
                if (data.isHTML) {
                    contentEl.innerHTML = data.current;
                } else {
                    contentEl.textContent = data.current;
                }

                if (data.next) {
                    nextEl.textContent = data.next;
                    nextContainer.style.display = 'block';
                } else {
                    nextContainer.style.display = 'none';
                }

                if (data.prev) {
                    prevEl.textContent = data.prev;
                    prevContainer.style.display = 'block';
                } else {
                    prevContainer.style.display = 'none';
                }
            }
        }

        function updateStatus(connected, text) {
            const dot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');

            if (connected) {
                dot.classList.add('online');
                statusText.textContent = text;
            } else {
                dot.classList.remove('online');
                statusText.textContent = text;
            }
        }

        function enableButtons() {
            document.querySelectorAll('.control-btn').forEach(btn => btn.disabled = false);
        }

        function disableButtons() {
            document.querySelectorAll('.control-btn').forEach(btn => btn.disabled = true);
        }



        function createRipple(event) {
            const button = event.currentTarget;
            const circle = document.createElement("span");
            const diameter = Math.max(button.clientWidth, button.clientHeight);
            const radius = diameter / 2;

            circle.style.width = circle.style.height = `${diameter}px`;
            circle.style.left = `${event.clientX - button.offsetLeft - radius}px`;
            circle.style.top = `${event.clientY - button.offsetTop - radius}px`;
            circle.classList.add("ripple");

            const ripple = button.getElementsByClassName("ripple")[0];
            if (ripple) { ripple.remove(); }
            button.appendChild(circle);
        }
    </script>
</body>

</html>