let currentMode="songs";function init(){const e=()=>{const e=document.getElementById("splashScreen");e&&(e.style.opacity="0",document.querySelector(".main-layout").classList.add("loaded"),setTimeout(()=>{e.style.display="none"},500))};try{const t=localStorage.getItem("bosquejos_songs");let o=t?JSON.parse(t):[],n=[],r=!1;if(void 0!==window.require)try{const e=window.require("fs"),t=window.require("path"),o=window.require("os"),i=t.join(o.homedir(),"Documents","Zion Presenter"),a=t.join(i,"Canciones.js");if(e.existsSync(a)){const t=e.readFileSync(a,"utf-8").replace(/^var\s+jscanciones\s*=\s*/,"").replace(/;?\s*$/,""),o=JSON.parse(t);Array.isArray(o)&&(n=o.map(e=>({id:e.id||generateUUID(),title:e.ti,lyrics:e.le,source:"file_external"})),r=!0,console.log("Base de datos externa cargada:",n.length,"cantos."))}else e.existsSync(i)||e.mkdirSync(i,{recursive:!0})}catch(e){console.error("Error cargando base de datos externa:",e)}!r&&"undefined"!=typeof jscanciones&&Array.isArray(jscanciones)&&(n=jscanciones.map(e=>({id:e.id||generateUUID(),title:e.ti,lyrics:e.le,source:"file"})));const i=JSON.parse(localStorage.getItem("bosquejos_deleted_ids")||"[]"),a=new Map;n.forEach(e=>{i.includes(e.id)||a.set(e.id,e)}),o.forEach(e=>a.set(e.id,e)),songs=Array.from(a.values()),0===songs.length&&(songs=[{id:"1",title:"Tu Fidelidad",lyrics:"Tu fidelidad es grande\nTu fidelidad incomparable es\nNadie como t√∫, bendito Dios\nGrande es tu fidelidad"},{id:"2",title:"Cuerdas de Amor",lyrics:"De lejos en mi dolor\nCon cuerdas de amor\nMe rescataste\n\nMe diste un nombre\nMe diste un lugar\nMe diste un prop√≥sito"}],saveData());const s=localStorage.getItem("bosquejos_setlist");s&&(setlist=JSON.parse(s)),window.addEventListener("keydown",e=>{const t=e.target.tagName;if(e.target.isContentEditable||"INPUT"===t||"TEXTAREA"===t||"SELECT"===t)return;const o=document.getElementById("songModal"),n=document.getElementById("creditsModal");o&&"flex"===o.style.display||n&&"flex"===n.style.display?"Escape"===e.key&&(closeModal(),n&&(n.style.display="none")):["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Space","PageUp","PageDown"].includes(e.key)?(e.preventDefault(),"ArrowRight"===e.key||"ArrowDown"===e.key||"PageDown"===e.key?"bible"===currentMode?nextVerse():nextSongSlide():"ArrowLeft"!==e.key&&"ArrowUp"!==e.key&&"PageUp"!==e.key||("bible"===currentMode?prevVerse():prevSongSlide())):"F5"!==e.key&&"b"!==e.key&&"B"!==e.key&&"Escape"!==e.key||(e.preventDefault(),blackout())}),console.log("üöÄ Iniciando Zion Presenter (Carga Progresiva)..."),updateDate(),initSongsSystem(),setMode("songs"),setTimeout(()=>{console.log("üì¶ Cargando M√≥dulo de Biblia..."),initBibleSystem()},150),setTimeout(()=>{console.log("üì¶ Cargando M√≥dulos Secundarios..."),initAnnouncementsSystem(),initTimerSystem()},350),setTimeout(()=>{loadConfig();const e=localStorage.getItem("bosquejos_bg"),t=localStorage.getItem("bosquejos_bg_type")||"image";e&&(bc.postMessage({type:"bg",action:"update",payload:{image:e,mediaType:t}}),updateBgPreview(e,t)),updateConfig(),console.log("‚úÖ Interfaz preparada en segundo plano.")},800),setTimeout(()=>{e(),localStorage.getItem("zion_welcome_shown")||setTimeout(()=>{showCredits(),localStorage.setItem("zion_welcome_shown","true")},500)},4e3),setTimeout(()=>{window.remoteServerURL&&document.querySelectorAll(".btn-remote").forEach(e=>{e.style.display="inline-flex",e.style.border="1px solid var(--accent)"})},1500)}catch(t){console.error("Error cr√≠tico en init():",t),showToast("Error al iniciar: "+t.message,"error"),e()}}function setMode(e){const t=document.getElementById("songsView"),o=document.getElementById("bibleView"),n=document.getElementById("announcementsView");currentMode=e,"announcements"!==e&&"function"==typeof stopPresentationMode&&stopPresentationMode(),t.style.display="none",o.style.display="none",n.style.display="none","songs"===e?t.style.display="contents":"bible"===e?(o.style.display="contents","undefined"!=typeof renderBooks&&renderBooks()):"announcements"===e&&(n.style.display="contents")}function toggleMode(){setMode("songs"===currentMode?"bible":"bible"===currentMode?"announcements":"songs")}function prevSlide(){"songs"===currentMode?prevSongSlide():"bible"===currentMode&&prevVerse()}function nextSlide(){"songs"===currentMode?nextSongSlide():"bible"===currentMode&&nextVerse()}function showCredits(){const e=document.getElementById("aboutModal");e&&(e.style.display="flex",e.offsetWidth,e.style.opacity="1")}if(void 0!==window.require){const{ipcRenderer:e}=window.require("electron");window.remoteServerURL="",e.on("server-ready",(e,t)=>{window.remoteServerURL=t,console.log("URL Remota (Evento):",t),document.querySelectorAll(".btn-remote").forEach(e=>{e.style.display="inline-flex",e.style.border="1px solid var(--accent)"})}),e.on("remote-command",(e,t)=>{console.log("Comando remoto:",t),"next"===t&&nextSlide(),"prev"===t&&prevSlide(),"blackout"===t&&blackout()}),window.showRemoteQR=function(){if(!window.remoteServerURL)return showToast("El servidor remoto no est√° listo.","error");const e=document.getElementById("qrModal");e&&e.remove();const t=document.createElement("div");t.id="qrModal",t.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:9999;backdrop-filter:blur(8px);";const o=document.createElement("div");o.style.cssText="background: #1a1a1a; padding: 0; border-radius: 20px; text-align: center; box-shadow: 0 50px 100px rgba(0,0,0,0.8); color: #fff; width: 700px; max-width: 95%; display: flex; overflow: hidden; border: 1px solid #333;";const n=document.createElement("div");n.style.cssText="flex: 1; padding: 40px; border-right: 1px solid #333; display: flex; flex-direction: column; align-items: center; justify-content: center;";const r=document.createElement("div");r.innerText="üì±",r.style.fontSize="40px",r.style.marginBottom="10px";const i=document.createElement("h3");i.innerText="Control Remoto",i.style.margin="0 0 20px 0",i.style.fontFamily="Inter, sans-serif";const a=document.createElement("canvas");window.require("qrcode").toCanvas(a,remoteServerURL,{width:200,margin:2,color:{dark:"#000000",light:"#ffffff"}},function(e){e&&console.error(e)}),a.style.borderRadius="10px";const s=document.createElement("p");s.innerHTML=`<span style="color:#888; font-size:12px;">Desde navegador m√≥vil:</span><br><b style="color:#4ade80; font-size:16px;">${remoteServerURL}</b>`,s.style.marginTop="20px",n.appendChild(r),n.appendChild(i),n.appendChild(a),n.appendChild(s);const d=document.createElement("div");d.style.cssText="flex: 1; padding: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #222;";const c=document.createElement("div");c.innerText="üé•",c.style.fontSize="40px",c.style.marginBottom="10px";const l=document.createElement("h3");l.innerText="Salida OBS / Red",l.style.margin="0 0 20px 0",l.style.fontFamily="Inter, sans-serif";const p=document.createElement("p");p.innerText="Agrega esta URL como 'Navegador' en OBS para recibir la imagen transparente:",p.style.color="#aaa",p.style.fontSize="13px",p.style.marginBottom="15px";const m=`${remoteServerURL}/visor`,u=document.createElement("div");u.innerText=m,u.style.cssText="background: #000; padding: 10px; border-radius: 6px; font-family: monospace; color: #06b6d4; margin-bottom: 20px; font-size: 14px; user-select: text; border: 1px solid #333; word-break: break-all;";const x=document.createElement("button");x.innerText="Copiar URL",x.className="primary",x.style.cssText="padding: 8px 20px; font-size: 14px;",x.onclick=()=>{navigator.clipboard.writeText(m),showToast("URL copiada al portapapeles","success")};const g=document.createElement("button");g.innerText="Cerrar",g.className="secondary",g.style.cssText="margin-top: auto; width: 100%; border-top: 1px solid #333; padding-top: 20px; background: transparent; border: none; color: #fff; cursor: pointer;",g.onclick=()=>t.remove(),d.appendChild(c),d.appendChild(l),d.appendChild(p),d.appendChild(u),d.appendChild(x),o.appendChild(n),o.appendChild(d),t.appendChild(o),t.onclick=e=>{e.target===t&&t.remove()},document.body.appendChild(t)}}else window.showRemoteQR=function(){const e=document.createElement("div");e.id="qrModal",e.onclick=()=>{e.style.opacity="0",setTimeout(()=>e.remove(),500)},e.style.cssText="display:flex; position:fixed; inset:0; background: var(--modal-overlay); backdrop-filter:blur(20px); z-index:20000; align-items:center; justify-content:center; opacity:0; transition:opacity 0.5s; padding:10px;";const t=document.createElement("div");t.onclick=e=>e.stopPropagation(),t.style.cssText="background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 16px; padding: 20px; width: 100%; max-width: 480px; max-height: 95vh; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.5); position: relative; overflow-y: auto;";const o=document.createElement("div");o.style.cssText="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, var(--brand-glow) 0%, transparent 70%); pointer-events: none; opacity: 0.2;",t.appendChild(o);const n="https://zionpresenter.com",r=document.createElement("div");r.style.cssText="text-align: center; margin-bottom: 15px; padding-bottom: 12px; border-bottom: 1px solid var(--card-border);",r.innerHTML=`\n            <div style="font-size: 8px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; font-weight: 600; margin-bottom: 6px;">C√≥digo de Sala</div>\n            <div id="roomStatus" style="background: var(--active-bg); color: var(--accent); padding: 6px 12px; border-radius: 6px; font-size: 20px; font-weight: 900; border: 1px solid var(--accent); letter-spacing: 2px; display: inline-block;">${currentRoomCode}</div>\n        `,t.appendChild(r);const i=document.createElement("div");i.style.cssText="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--card-border);",i.innerHTML='\n            <h3 style="color: var(--text); font-size: 10px; text-transform: uppercase; letter-spacing: 0.8px; margin: 0 0 6px 0; font-weight: 700;">\n                <span style="color: var(--accent);">‚óè</span> Visor\n            </h3>\n            <p style="color: var(--text-muted); font-size: 10px; margin: 0 0 8px 0; line-height: 1.3;">Para OBS, proyector u otra PC</p>\n        ';const a=`${n}/v/${currentRoomCode}`,s=document.createElement("input");s.id="visorLink",s.type="text",s.value=a,s.readOnly=!0,s.style.cssText="width: 100%; padding: 8px; margin-bottom: 8px; font-family: monospace; text-align: center; font-weight: 600; background: rgba(0,0,0,0.3); border: 1px solid var(--card-border); border-radius: 6px; color: var(--accent); font-size: 11px;",s.onclick=()=>s.select();const d=document.createElement("div");d.style.cssText="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;";const c=document.createElement("button");c.innerText="Copiar",c.onclick=copyVisorLink,c.style.cssText="background: var(--accent); color: var(--bg); border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 10px;";const l=document.createElement("button");l.innerText="Cambiar",l.onclick=()=>{regenerateRoomCode(),s.value=`${n}/v/${currentRoomCode}`,g.value=`${n}/remote?room=${currentRoomCode}`,document.getElementById("roomStatus").textContent=currentRoomCode,u.innerHTML="",x(`${n}/remote?room=${currentRoomCode}`,u)},l.style.cssText="background: transparent; color: var(--text); border: 1px solid var(--card-border); padding: 8px; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 10px;",d.appendChild(c),d.appendChild(l),i.appendChild(s),i.appendChild(d),t.appendChild(i);const p=document.createElement("div");p.style.cssText="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--card-border);",p.innerHTML='\n            <h3 style="color: var(--text); font-size: 10px; text-transform: uppercase; letter-spacing: 0.8px; margin: 0 0 6px 0; font-weight: 700;">\n                <span style="color: var(--accent);">‚óè</span> Control M√≥vil\n            </h3>\n            <p style="color: var(--text-muted); font-size: 10px; margin: 0 0 8px 0; line-height: 1.3;">Escanea el QR o abre el enlace</p>\n        ';const m=`${n}/remote?room=${currentRoomCode}`,u=document.createElement("div");function x(e,t){const o=document.createElement("img");o.src=`https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=${encodeURIComponent(e)}`,o.style.cssText="display: block; border-radius: 6px; width: 160px; height: 160px;",t.appendChild(o)}u.style.cssText="display: flex; justify-content: center; margin: 12px 0; padding: 12px; background: white; border-radius: 12px;",x(m,u);const g=document.createElement("input");g.type="text",g.value=m,g.readOnly=!0,g.style.cssText="width: 100%; padding: 8px; font-family: monospace; text-align: center; background: rgba(0,0,0,0.3); border: 1px solid var(--card-border); border-radius: 6px; margin-bottom: 8px; color: var(--accent); font-size: 11px;",g.onclick=()=>g.select();const y=document.createElement("button");y.innerText="Copiar Enlace",y.style.cssText="width: 100%; background: var(--accent); color: var(--bg); border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 10px;",y.onclick=()=>{navigator.clipboard.writeText(m),showToast("Enlace del control remoto copiado","success")},p.appendChild(u),p.appendChild(g),p.appendChild(y),t.appendChild(p);const b=document.createElement("button");b.innerText="Cerrar",b.style.cssText="width: 100%; background: transparent; color: var(--text-muted); border: 1px solid var(--card-border); padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 10px; margin-top: 4px;",b.onclick=()=>{e.style.opacity="0",setTimeout(()=>e.remove(),500)},t.appendChild(b),e.appendChild(t),document.body.appendChild(e),setTimeout(()=>e.style.opacity="1",10)};document.addEventListener("DOMContentLoaded",()=>{try{init()}catch(e){console.error("Error:",e)}});