const bc=new BroadcastChannel("zion-presenter");window.zionRoomCode=localStorage.getItem("zion_panel_room")||null,window.updateZionRoomCode=function(o){window.zionRoomCode=o,localStorage.setItem("zion_panel_room",o),console.log(`ðŸ” Room code actualizado: ${o}`)};let networkSocket=null;if(void 0!==window.require)try{const{ipcRenderer:o}=window.require("electron"),e=bc.postMessage.bind(bc);bc.postMessage=t=>{e(t),o.send("broadcast-to-network",t)},console.log("Puente de Red (Electron): ACTIVADO"),o.on("request-state-sync",()=>{console.log("Sincronizando visor web...");const o=localStorage.getItem("bosquejos_config");o&&bc.postMessage({type:"config",action:"update",payload:JSON.parse(o)})})}catch(o){console.error("Error activando puente de red (Electron):",o)}else if(window.location.protocol.startsWith("http")){const o=document.createElement("script");o.src="/socket.io/socket.io.js",o.onload=()=>{console.log("Socket.IO cargado en panel web"),networkSocket=io(),networkSocket.on("connect",()=>{console.log("Panel conectado a red Socket.IO! [OK]");const o=()=>{"undefined"!=typeof currentRoomCode&&currentRoomCode?(console.log(`[ROOM] UniÃ©ndose a sala: ${currentRoomCode}`),networkSocket.emit("join_room",{roomCode:currentRoomCode}),setTimeout(()=>{networkSocket.emit("remote_action",{type:"panel_status",action:"ready",room:currentRoomCode}),console.log("ðŸ“¡ Panel seÃ±alizado como activo")},500)):(console.log("â³ Esperando currentRoomCode..."),setTimeout(o,100))};o();const e=localStorage.getItem("bosquejos_config");e&&(networkSocket.emit("remote_action",{type:"config",action:"update",payload:JSON.parse(e)}),console.log("ðŸ“¤ ConfiguraciÃ³n enviada al visor"))}),networkSocket.on("disconnect",()=>{console.log("Panel desconectado de la red [!]")}),networkSocket.on("network_update",o=>{if("remote_cmd"===o.type)switch(console.log(`[CMD] Comando remoto recibido: ${o.action}`),o.action){case"next":"function"==typeof nextSlide&&nextSlide();break;case"prev":"function"==typeof prevSlide&&prevSlide();break;case"blackout":"function"==typeof blackout&&blackout()}else"select_song"===o.type?(console.log(`[SONG] Seleccionando canto #${o.index}`),"function"==typeof window.selectSongByIndex&&window.selectSongByIndex(o.index)):"timer_control"===o.type?(console.log(`â±ï¸ Control de timer: ${o.action}`),"toggle"===o.action?"function"==typeof window.toggleTimer&&window.toggleTimer():"reset"===o.action&&"function"==typeof window.resetTimer&&window.resetTimer()):"show_verse"===o.type?(console.log(`[BIBLE] Mostrando versÃ­culo: ${o.verse}`),"function"==typeof window.showVerseFromRemote&&window.showVerseFromRemote(o.verse)):"request_data"===o.type&&(console.log("[INFO] Control remoto solicitÃ³ datos iniciales"),sendSongsListToRemote())}),networkSocket.on("server_info",o=>{console.log("[SERVER] InformaciÃ³n del servidor recibida:",o),window.serverBaseURL=o.baseURL,window.serverIP=o.ip,window.serverPort=o.port});const o=bc.postMessage.bind(bc);bc.postMessage=e=>{if(o(e),networkSocket&&networkSocket.connected){const o=window.ZION_ROOM_CODE,t=o?{...e,room:o}:e;console.log(`ðŸ“¤ Enviando a sala ${o||"SIN SALA"}:`,e.type),networkSocket.emit("remote_action",t)}},console.log("Puente de Red (Web): ACTIVADO")},o.onerror=()=>{console.error("Error cargando Socket.IO")},document.head.appendChild(o)}let overlayWindow=null;function openOverlay(){overlayWindow=window.open("cantos_overlay.html","Overlay","width=1280,height=720,menubar=no,toolbar=no,location=no,status=no")}function updatePreviewText(o,e){const t=document.getElementById(o);t&&(t.innerText=e,fitTextToBox(t))}function updatePreviewHTML(o,e){const t=document.getElementById(o);t&&(t.innerHTML=e,fitTextToBox(t))}window.addEventListener("beforeunload",()=>{overlayWindow&&!overlayWindow.closed&&overlayWindow.close()});const ZION_PLACEHOLDER='<div style="display:flex; align-items:center; justify-content:center; opacity:0.12; transform: scale(0.8); pointer-events:none; gap:12px;">\n    <svg width="45" height="45" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n        <path d="M21 3H3C1.89 3 1 3.89 1 5v12c0 1.1.89 2 2 2h5v2h8v-2h5c1.1 0 2-.9 2-2V5c0-1.11-.9-2-2-2zm0 14H3V5h18v12z" fill="currentColor" />\n        <path d="M5 16h14l-4.5-6-3.5 4.5-2.5-3L5 16z" fill="currentColor" />\n    </svg>\n    <div style="text-align:left;">\n        <div style="font-weight:900; font-size:22px; letter-spacing:1px; color:currentColor; line-height:0.8;">ZION</div>\n        <div style="font-weight:300; font-size:11px; letter-spacing:3px; color:currentColor; line-height:1; margin-top:2px;">PRESENTER</div>\n    </div>\n</div>';function blackout(){bc.postMessage({type:"nav",action:"blackout"}),updatePreviewHTML("livePreview",ZION_PLACEHOLDER),updatePreviewHTML("biblePreview",ZION_PLACEHOLDER),updatePreviewHTML("announcementLivePreview",ZION_PLACEHOLDER);const o=document.getElementById("currentLyricsList");o&&Array.from(o.children).forEach(o=>o.classList.remove("active")),"undefined"!=typeof currentStanzaIndex&&(currentStanzaIndex=-1)}function sendSongsListToRemote(){if(void 0===networkSocket||!networkSocket)return;const o=[],e=document.querySelectorAll("#setlistList .list-item");if(e&&e.length>0)e.forEach((e,t)=>{const n=e.querySelector("div"),r=(n?n.textContent.trim():`Canto ${t+1}`).replace(/^\d+\.\s*/,"");o.push({title:r,number:t+1,index:t})}),console.log(`[DOM] ${o.length} cantos obtenidos del DOM (#setlistList)`);else try{const e=localStorage.getItem("bosquejos_setlist");if(!e)return void console.log("ðŸ“‹ No hay setlist disponible");const t=JSON.parse(e);let n=[];if(void 0!==window.songs&&Array.isArray(window.songs))n=window.songs,console.log(`ðŸ“Š ${n.length} cantos encontrados en window.songs`);else{const o=localStorage.getItem("bosquejos_songs");o&&(n=JSON.parse(o),console.log(`ðŸ“Š ${n.length} cantos encontrados en localStorage`))}t.forEach((e,t)=>{const r=n.find(o=>o.id===e);o.push({title:r?r.title:`Canto ${t+1}`,number:t+1,index:t})})}catch(o){console.error("Error al obtener cantos:",o)}networkSocket.emit("remote_action",{type:"songs_list",songs:o}),console.log(`ðŸ“¤ Lista de ${o.length} cantos enviada al control remoto`)}window.sendSongsListToRemote=sendSongsListToRemote;